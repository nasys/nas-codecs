function stringFromUTF8Array(t){for(var e=[1,1,1,1,2,2,3,0],r=t.length,n="",i=0;i<r;){var a=t[i++];if(128&a){var s=e[a>>3&7];if(!(64&a)||!s||i+s>r)return null;for(a&=63>>s;s>0;s-=1){var o=t[i++];if(128!=(192&o))return null;a=a<<6|63&o}}n+=String.fromCharCode(a)}return n}function BitExtract(t){this.data=t,this.offset=0}function BinaryExtract(t){this.buffer=t,this.offset=0}function pad(t,e){for(var r=""+t;r.length<e;)r="0"+r;return r}function intToHexStr(t,e){return pad(t.toString(16).toUpperCase(),e)}function objToList(t){var e=[];for(var r in t)void 0!==t[r]&&t[r]&&e.push(r);return e}function meterStatusFormat(t,e){switch(t){case 0:return"connected";case 1:return"no_response";case 2:case 4:return"protocol_error";case 3:return"meter_damaged";case 5:return"bus_shorted";default:return e.errors.push("invalid_status"),"invalid_status"}}function meterMultiplierConvert(t){return t<3||t>7?-1:Math.pow(10,t-6)}function meterMediumFormat(t,e){switch(t){case 0:return"water";case 1:return"warm_water";case 2:return"gas";default:return e.errors.push("invalid_medium"),"invalid_medium"}}function meterUnitFormat(t,e){switch(t){case 0:return"m3";case 1:return"gal";case 2:return"ft3";default:return e.errors.push("invalid_unit"),"invalid_unit"}}function serialFormat(t){return 4294967295===t?"not_available":intToHexStr(t,8)}function actualityDurationToMinutesFormat(t){return t<60?t:t<156?15*(t-60):t<200?24*(t-156)*60:t<253?7*(t-200)*24*60:253===t?525600:null}function actualityDurationToFormatStr(t){var e=actualityDurationToMinutesFormat(t);return t<60?e+" minutes":t<156?(e/60).toFixed(2)+" hours":t<200?(e/1440).toFixed(2)+" days":t<253?(e/10080).toFixed(2)+" weeks":253===t?(e/525600).toFixed(2)+" years":null}function multiplierToExponent(t){switch(t){case.001:return-3;case.01:return-2;case.1:return-1;case 1:return 0;case 10:return 1;default:throw Error("invalid_multiplier")}}function volumeFormatUnit(t,e){var r=multiplierToExponent(e),n=pad((r>0?t:t/e).toFixed(0),r>0?8+r:8);return r<0&&(n=n.substring(0,8+r)+"."+n.substring(8+r)),n}function lorawanProfileFormat(t,e){switch(t){case 0:return"lorawan_disabled";case 1:return"lorawan_24_h_privacy";case 2:return"lorawan_24_h";case 3:return"lorawan_12_h";case 7:return"lorawan_1_h_static";case 8:return"lorawan_15_min_static";case 23:return"lorawan_1_h_dynamic";case 24:return"lorawan_15_min_dynamic";default:return e.errors.push("invalid_lorawan_profile"),"invalid_lorawan_profile"}}function wmbusProfileFormat(t,e){switch(t){case 0:return"wmbus_disabled";case 1:return"wmbus_privacy";case 2:return"wmbus_driveby";case 3:return"wmbus_fixnet";default:return e.errors.push("invalid_wmbus_profile"),"invalid_wmbus_profile"}}function packetErrorReasonFormatter(t){switch(t){case 0:case 1:return"n/a";case 2:return"unknown_fport";case 3:return"packet_size_short";case 4:return"packet_size_long";case 5:return"value_error";case 6:return"protocol_parse_error";case 7:return"reserved_flag_set";case 8:return"invalid_flag_combination";case 9:return"unavailable_feature_request";case 10:return"unsupported_header";case 11:return"unreachable_hw_request";case 12:return"address_not_available";case 13:return"internal_error";default:return"invalid_error_code"}}function hardwareConfigFormat(t,e){switch(t){case 0:return"Modularis";case 1:return"Cyble";case 2:return"Falcon_PR";case 3:return"Picoflux";case 4:return"Falcon_MJ";case 6:return"RCM_LMx";case 32:return"BK_G";default:return e.errors.push("invalid_hardware_config"),"invalid_hardware_config"}}function shutdownReasonFormat(t,e){switch(t){case 16:return"calibration_timeout";case 49:return"magnet_shutdown";case 50:return"enter_dfu";case 51:return"app_shutdown";case 52:return"switch_to_wmbus";default:return e.errors.push("invalid_shutdown_reason"),"invalid_shutdown_reason"}}function bootPacketReason(t,e){switch(t){case 0:return"unknown_reset";case 1:return"from_shutdown";case 2:return"from_dfu";case 3:return"froced_reset";case 4:return"lorawan_rejoin";default:return e.errors.push("invalid_packet_reason"),"invalid_packet_reason"}}function usageParser(t,e,r){e.packet_type="usage_packet";var n={},i=t.getUint8Bits();n.backflow_pending=i.getBits(1),n.broken_pipe_pending=i.getBits(1),n.continuous_flow_pending=i.getBits(1),n.tamper_pending=i.getBits(1),n.temperature_pending=i.getBits(1),n.low_battery=i.getBits(1),n.no_usage=i.getBits(1),e.active_alerts=n,e.meter_status=meterStatusFormat(t.getUint8(),r);var a=t.getUint8Bits();if(e.meter_multiplier=meterMultiplierConvert(a.getBits(3)),e.meter_multiplier<0)r.errors.push("invalid_multiplier");else{e.meter_medium=meterMediumFormat(a.getBits(2),r),e.meter_unit=meterUnitFormat(a.getBits(2),r);var s=a.getBits(1),o=t.getUint8();if(e.meter_actuality_duration__minutes=actualityDurationToMinutesFormat(o),e.meter_actuality_duration_formatted=actualityDurationToFormatStr(o),e["meter_accumulated_volume__"+e.meter_unit]=volumeFormatUnit(e.meter_multiplier*t.getUint32(),e.meter_multiplier),s){var _=t.getUint8Bits(),u=_.getBits(5),c=_.getBits(3),l=t.getUint8Bits(),f=l.getBits(4),g=2e3+c+8*l.getBits(4),d=new Date;d.setUTCFullYear(g),d.setUTCMonth(f,u),d.setUTCDate(u),e.meter_readout_date=d.toISOString().split(/[T ]/i,1)[0]}var p=t.getUint8Bits();if(e.app_connected_within_a_day=p.getBits(1),p.getBits(1)){e.battery_remaining__years=parseFloat((t.getUint8()/12).toFixed(1)),e.battery_voltage__V=parseFloat((t.getUint8()/100+1.5).toFixed(2)),e.internal_temperature__C=t.getInt8();var m=t.getUint8Bits();e.internal_temperature_min__C=-2*m.getBits(4)+e.internal_temperature__C,e.internal_temperature_max__C=2*m.getBits(4)+e.internal_temperature__C,e.radio_downlink_rssi__dBm=-1*t.getUint8();var h=t.getUint8Bits();e.radio_downlink_snr__dB=2*h.getBits(4)-20,e.radio_uplink_power__dBm=2*h.getBits(4),e.meter_serial=serialFormat(t.getUint32())}}}function generalConfigurationParser(t,e,r){e.packet_type="general_configuration_packet";var n={},i=t.getUint8Bits();n.radio_lorawan_profile_sent=i.getBits(1),n.radio_wmbus_profile_sent=i.getBits(1),n.meter_serial_sent=i.getBits(1),n.meter_multiplier_sent=i.getBits(1),n.meter_volume_sent=i.getBits(1),n.meter_volume_offset_sent=i.getBits(1),n.meter_nominal_flow_sent=i.getBits(1),n.alert_backflow_sent=i.getBits(1);var a=t.getUint8Bits();n.alert_broken_pipe_sent=a.getBits(1),n.alert_continuous_flow_sent=a.getBits(1),n.alert_no_usage_sent=a.getBits(1),n.alert_tamper_sent=a.getBits(1),n.alert_temperature_sent=a.getBits(1),n.radio_lorawan_profile_sent&&(e.radio_lorawan_profile=lorawanProfileFormat(t.getUint8(),r)),n.radio_wmbus_profile_sent&&(e.radio_wmbus_profile=wmbusProfileFormat(t.getUint8(),r)),n.meter_serial_sent&&(e.meter_serial=serialFormat(t.getUint32()));var s="",o="";if(n.meter_multiplier_sent){var _=t.getUint8Bits();e.meter_multiplier=meterMultiplierConvert(_.getBits(3)),e.meter_medium=meterMediumFormat(_.getBits(2),r),e.meter_unit=meterUnitFormat(_.getBits(2),r),o=(s=""!==e.meter_unit?"__"+e.meter_unit:"")?s+"_per_h":"",e.privacy_mode_active=_.getBits(1)}if(n.meter_volume_sent&&(e["meter_accumulated_volume"+s]=t.getUint64()/1e3),n.meter_volume_offset_sent&&(e["meter_accumulated_volume_offset"+s]=t.getInt32()/1e3),n.meter_nominal_flow_sent&&(e["meter_nominal_flow"+o]=t.getUint16()/10),n.alert_backflow_sent){var u=t.getUint16();e.alert_backflow_threshold=0===u?"disabled":u/1e3}if(n.alert_broken_pipe_sent){var c=t.getUint32();e["alert_broken_pipe_threshold"+o]=0===c?"disabled":c/1e3}if(n.alert_continuous_flow_sent&&(e.alert_continuous_flow_enabled=Boolean(t.getUint8())),n.alert_no_usage_sent){var l=t.getUint16();e.alert_no_usage_interval__days=0===l?"disabled":l}if(n.alert_tamper_sent&&(e.alert_tamper_enabled=Boolean(t.getUint8())),n.alert_temperature_sent){var f=t.getInt8();e.alert_temperature_threshold_low__C=-128===f?"disabled":f;var g=t.getInt8();e.alert_temperature_threshold_high__C=-128===g?"disabled":g}}function locationConfigurationParser(t,e){e.packet_type="location_configuration_packet";var r={},n=t.getUint8Bits();if(r.gps_position_sent=n.getBits(1),r.time_zone_sent=n.getBits(1),r.address_sent=n.getBits(1),r.id_customer_sent=n.getBits(1),r.id_location_sent=n.getBits(1),r.gps_position_sent&&(e.gps_position_latitude__deg=t.getInt32()/1e7,e.gps_position_longitude__deg=t.getInt32()/1e7),r.time_zone_sent&&(e.time_zone__h=t.getInt8()/4),r.address_sent){var i=t.getUint8();e.address=t.getTextUtf8(i)}if(r.id_customer_sent){var a=t.getUint8();e.id_customer=t.getTextUtf8(a)}if(r.id_location_sent){var s=t.getUint8();e.id_location=t.getTextUtf8(s)}}function configurationParser(t,e,r,n){32===e?generalConfigurationParser(t,r,n):33===e?locationConfigurationParser(t,r):n.errors.push("invalid_configuration_type "+e)}function configurationRequestsParser(t,e){32===packet_type?t.packet_type="general_configuration_request":33===packet_type?t.packet_type="location_configuration_request":e.errors.push("invalid_request_type "+packet_type)}function commandParser(t,e,r,n){if(3===e){if(1===t.availableLen())return void(r.packet_type="local_time_request");r.packet_type="local_time_response",r.device_local_time__s=t.getUint32();var i=new Date(1e3*r.device_local_time__s);r.device_local_time_formatted=i.toISOString().replace(/.\d+Z$/g,"Z");r.device_local_time__s<1577836800&&(r.device_local_time_formatted="invalid")}else 255===e?r.packet_type="enter_dfu_command":n.errors.push("invalid_command_type "+e)}function sysMessagesParser(t,e,r,n){if(19===e)r.packet_type="faulty_downlink_packet",r.packet_fport=t.getUint8(),r.packet_error_reason=packetErrorReasonFormatter(t.getUint8()),n.warnings.push("faulty_downlink_packet: "+r.packet_error_reason);else if(0===e){r.packet_type="boot_packet",r.device_serial=serialFormat(t.getUint32()),r.device_firmware_version=t.getUint8().toString()+"."+t.getUint8()+"."+t.getUint8();var i=t.getUint8Bits(),a={};a.reason_0=i.getBits(1),a.watchdog_reset=i.getBits(1),a.soft_reset=i.getBits(1),a.reason_3=i.getBits(1),a.magnet_wakeup=i.getBits(1),a.reason_5=i.getBits(1),a.reason_6=i.getBits(1),a.nfc_wakeup=i.getBits(1),r.wakeup_reason_mcu=objToList(a);var s=t.getUint8Bits();s.getBits(4),r.packet_reason=bootPacketReason(s.getBits(3),n),r.configuration_restored=s.getBits(1),r.hardware_configuration=hardwareConfigFormat(t.getUint8(),n),t.getUint8(),t.getUint8(),r.device_uptime_accumulated__days=parseFloat((t.getUint24()/24).toFixed(2))}else if(1===e){var o=shutdownReasonFormat(t.getUint8(),n);4!==t.getUint8()&&n.errors.push("no_usage_header_found"),usageParser(t,r,n),r.packet_type="shutdown_packet",r.shutdown_reason=o}else n.errors.push("invalid_sys_msg_type "+e)}function checkFport(t,e,r){t!==e&&r.errors.push("wrong fport or header")}function decodeByPacketHeader(t,e,r,n){var i=new BinaryExtract(e);if(0===i.availableLen())return n.errors.push("empty_payload"),r;var a=i.getUint8();return 4===a?(usageParser(i,r,n),checkFport(t,25,n)):32===a||33===a?1===e.length?(configurationRequestsParser(a,r),checkFport(t,49,n)):(configurationParser(i,a,r,n),checkFport(t,50,n)):3===a||255===a?(commandParser(i,a,r,n),checkFport(t,60,n)):0===a||1===a||19===a?(sysMessagesParser(i,a,r,n),checkFport(t,99,n)):n.errors.push("invalid_packet_type"),i.availableLen()>0&&n.errors.push("packet_too_long"),r}function decodeRaw(t,e){var r={},n={errors:[],warnings:[]};try{decodeByPacketHeader(t,e,r,n)}catch(t){n.errors.push(t.message)}return{data:r,errors:n.errors,warnings:n.warnings}}function decodeDownlink(t){return decodeRaw(t.fPort,t.bytes)}function decodeUplink(t){return decodeRaw(t.fPort,t.bytes)}function Decoder(t,e){return decodeRaw(e,t)}function Decode(t,e){return decodeRaw(t,e)}BitExtract.prototype._assertOnRemainingLength=function(t){if(0===t)throw Error("invalid zero length bit field");if(this.offset+t>8)throw Error("invalid number of bits extracted")},BitExtract.prototype.getBits=function(t){this._assertOnRemainingLength(t);var e=Math.pow(2,t)-1,r=this.data>>this.offset&e;return this.offset+=t,1===t?Boolean(r):r},BinaryExtract.prototype.availableLen=function(){return this.buffer.length-this.offset},BinaryExtract.prototype._assertOnRemainingLength=function(t){if(t>this.availableLen())throw Error("invalid buffer length: too short")},BinaryExtract.prototype.getUint8=function(){return this._assertOnRemainingLength(1),this.buffer[this.offset++]},BinaryExtract.prototype.getInt8=function(){var t=this.getUint8();return t>127?t-256:t},BinaryExtract.prototype.getUint16=function(){return this._assertOnRemainingLength(2),this.buffer[this.offset++]+256*this.buffer[this.offset++]},BinaryExtract.prototype.getInt16=function(){var t=this.getUint16();return t>32767?t-65536:t},BinaryExtract.prototype.getUint24=function(){return this._assertOnRemainingLength(3),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]},BinaryExtract.prototype.getUint32=function(){return this._assertOnRemainingLength(4),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]+16777216*this.buffer[this.offset++]},BinaryExtract.prototype.getInt32=function(){var t=this.getUint32();return t>2147483647?t-4294967296:t},BinaryExtract.prototype.getUint64=function(){return this.getUint32()+4294967296*this.getUint32()},BinaryExtract.prototype.getTextUtf8=function(t){this._assertOnRemainingLength(t);var e=stringFromUTF8Array(this.buffer.slice(this.offset,this.offset+t));return this.offset+=t,e},BinaryExtract.prototype.getUint8Bits=function(){return new BitExtract(this.getUint8())},BinaryExtract.prototype.getRaw=function(t){this._assertOnRemainingLength(t);var e=this.buffer.slice(this.offset,this.offset+t);return this.offset+=t,e},BinaryExtract.prototype.getFloat=function(){var t=this.getUint32(),e=2147483648&t?-1:1,r=(t>>23&255)-127,n=8388607&t;if(128===r)return e*(n?Number.NaN:Number.POSITIVE_INFINITY);if(-127===r){if(0===n)return 0*e;r=-126,n/=1<<22}else n=(n|1<<23)/(1<<23);return e*n*Math.pow(2,r)};
