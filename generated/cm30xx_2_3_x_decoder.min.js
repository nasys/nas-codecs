function BitExtract(t){this.data=t,this.offset=0}function BinaryExtract(t){this.buffer=t,this.offset=0}function stringFromUTF8Array(t){for(var e=[1,1,1,1,2,2,3,0],r=t.length,n="",a=0;a<r;){var i=t[a++];if(128&i){var o=e[i>>3&7];if(!(64&i)||!o||a+o>r)return null;for(i&=63>>o;o>0;o-=1){var s=t[a++];if(128!=(192&s))return null;i=i<<6|63&s}}n+=String.fromCharCode(i)}return n}function pad(t,e){for(var r=""+t;r.length<e;)r="0"+r;return r}function bytesToHexStr(t){for(var e="",r=0;r<t.length;r++)e+=("00"+t[r].toString(16)).slice(-2).toUpperCase();return e}function meterStatusFormat(t){switch(t){case 0:return"connected";case 1:return"no_response";case 2:case 4:return"protocol_error";case 3:return"meter_damaged";case 5:return"bus_shorted";default:return"invalid_status"}}function meterMultiplierConvert(t){return t<3||t>7?-1:Math.pow(10,t-6)}function meterMediumFormat(t){switch(t){case 0:return"water";case 1:return"warm_water";case 2:return"gas";default:return"invalid_medium"}}function meterUnitFormat(t){switch(t){case 0:return"m3";case 1:return"gal";case 2:return"ft3";default:return"invalid_unit"}}function serialFormat(t){return 4294967295===t?"not_available":pad(t.toString(16).toUpperCase(),8)}function actualityDurationToMinutesFormat(t){return t<60?t:t<156?15*(t-60):t<200?24*(t-156)*60:t<253?7*(t-200)*24*60:253===t?525600:null}function actualityDurationToFormatStr(t){var e=actualityDurationToMinutesFormat(t);return t<60?e+" minutes":t<156?(e/60).toFixed(2)+" hours":t<200?(e/1440).toFixed(2)+" days":t<253?(e/10080).toFixed(2)+" weeks":253===t?(e/525600).toFixed(2)+" years":null}function multiplierToExponent(t){switch(t){case.001:return-3;case.01:return-2;case.1:return-1;case 1:return 0;case 10:return 1;default:throw Error("invalid_multiplier")}}function volumeFormatUnit(t,e){var r=multiplierToExponent(e),n=pad((r>0?t:t/e).toFixed(0),r>0?8+r:8);return r<0&&(n=n.substring(0,8+r)+"."+n.substring(8+r)),n}function activeAlertsFormat(t){var e=[];for(var r in t)t.hasOwnProperty(r)&&t[r]&&"any_alert_active_now"!==r&&e.push(r);return e}function lorawanProfileFormat(t){switch(t){case 0:return"lorawan_disabled";case 1:return"lorawan_24_h_privacy";case 2:return"lorawan_24_h";case 3:return"lorawan_12_h";case 7:return"lorawan_1_h_static";case 8:return"lorawan_15_min_static";case 23:return"lorawan_1_h_dynamic";case 24:return"lorawan_15_min_dynamic";default:return"invalid_lorawan_profile"}}function wmbusProfileFormat(t){switch(t){case 0:return"wmbus_disabled";case 1:return"wmbus_privacy";case 2:return"wmbus_driveby";case 3:return"wmbus_fixnet";default:return"invalid_wmbus_profile"}}function packetErrorReasonFormatter(t){switch(t){case 0:case 1:return"n/a";case 2:return"unknown_fport";case 3:return"packet_size_short";case 4:return"packet_size_long";case 5:return"value_error";case 6:return"protocol_parse_error";case 7:return"reserved_flag_set";case 8:return"invalid_flag_combination";case 9:return"unavailable_feature_request";case 10:return"unsupported_header";case 11:return"unreachable_hw_request";case 12:return"address_not_available";case 13:return"internal_error";default:return"invalid_error_code"}}function hardwareConfigFormat(t){switch(t){case 0:return"Modularis";case 1:return"Cyble";case 2:return"Falcon_PR";case 3:return"Picoflux";case 4:return"Falcon_MJ";case 6:return"RCM_LMx";case 32:return"BK_G";default:return"invalid_hardware_config"}}function shutdownEeasonFormat(t){switch(t){case 16:return"calibration_timeout";case 49:return"magnet_shutdown";case 50:return"enter_dfu";case 51:return"app_shutdown";case 52:return"switch_to_wmbus";default:return"invalid_shutdown_reason"}}function bootPacketReason(t){switch(t){case 0:return"unknown_reset";case 1:return"from_shutdown";case 2:return"from_dfu";case 3:return"froced_reset";case 3:return"lorawan_rejoin";default:return"invalid_packet_reason"}}function wakeupReasonFormat(t){var e=[];for(var r in t)t.hasOwnProperty(r)&&t[r]&&e.push(r);return e}function usageParser(t,e){var r=new BinaryExtract(t),n=r.getUint8();if(4===n){e._packet_type="usage_packet";var a={},i=r.getUint8Bits();a.backflow_pending=i.getBits(1),a.broken_pipe_pending=i.getBits(1),a.continuous_flow_pending=i.getBits(1),a.tamper_pending=i.getBits(1),a.temperature_pending=i.getBits(1),a.low_battery=i.getBits(1),a.no_usage=i.getBits(1),a.any_alert_active_now=i.getBits(1),e.active_alerts=activeAlertsFormat(a),e.meter_status=meterStatusFormat(r.getUint8());var o=r.getUint8Bits();if(e._meter_multiplier=meterMultiplierConvert(o.getBits(3)),e._meter_multiplier<0)e._error=["invalid_multiplier"];else{e._meter_medium=meterMediumFormat(o.getBits(2)),e._meter_unit=meterUnitFormat(o.getBits(2));var s=o.getBits(1),_=r.getUint8();if(e.meter_actuality_duration__minutes=actualityDurationToMinutesFormat(_),e.meter_actuality_duration_formatted=actualityDurationToFormatStr(_),e["meter_accumulated_volume__"+e._meter_unit]=volumeFormatUnit(e._meter_multiplier*r.getUint32(),e._meter_multiplier),s){var u=r.getUint8Bits(),c=u.getBits(5),l=u.getBits(3),f=r.getUint8Bits(),g=f.getBits(4),m=2e3+l+8*f.getBits(4),d=new Date;d.setUTCFullYear(m),d.setUTCMonth(g),d.setUTCDate(c),e.meter_readout_date=d.toISOString().split(/[T ]/i,1)[0]}var p=r.getUint8Bits();if(e._app_connected_within_a_day=p.getBits(1),p.getBits(1)){e.battery_remaining__years=parseFloat((r.getUint8()/12).toFixed(1)),e._battery_voltage__V=r.getUint8()/100+1.5,e.internal_temperature__C=r.getInt8();var h=r.getUint8Bits();e._internal_temperature_min__C=-2*h.getBits(4)+e.internal_temperature__C,e._internal_temperature_max__C=2*h.getBits(4)+e.internal_temperature__C,e.radio_downlink_rssi__dBm=-1*r.getUint8();var v=r.getUint8Bits();e._radio_downlink_snr__dB=2*v.getBits(4)-20,e._radio_uplink_power__dBm=2*v.getBits(4),e.meter_serial=serialFormat(r.getUint32())}}}else e._error=["invalid_packet_type "+n]}function generalConfigurationParser(t,e){e._packet_type="general_configuration_packet";var r={},n=t.getUint8Bits();r.radio_lorawan_profile_sent=n.getBits(1),r.radio_wmbus_profile_sent=n.getBits(1),r.meter_serial_sent=n.getBits(1),r.meter_multiplier_sent=n.getBits(1),r.meter_volume_sent=n.getBits(1),r.meter_volume_offset_sent=n.getBits(1),r.meter_nominal_flow_sent=n.getBits(1),r.alert_backflow_sent=n.getBits(1);var a=t.getUint8Bits();if(r.alert_broken_pipe_sent=a.getBits(1),r.alert_continuous_flow_sent=a.getBits(1),r.alert_no_usage_sent=a.getBits(1),r.alert_tamper_sent=a.getBits(1),r.alert_temperature_sent=a.getBits(1),r.radio_lorawan_profile_sent&&(e.radio_lorawan_profile=lorawanProfileFormat(t.getUint8())),r.radio_wmbus_profile_sent&&(e.radio_wmbus_profile=wmbusProfileFormat(t.getUint8())),r.meter_serial_sent&&(e.meter_serial=serialFormat(t.getUint32())),e.meter_unit="",r.meter_multiplier_sent){a=t.getUint8Bits();e.meter_multiplier=meterMultiplierConvert(a.getBits(3)),e.meter_medium=meterMediumFormat(a.getBits(2)),e.meter_unit=meterUnitFormat(a.getBits(2)),e.privacy_mode_active=a.getBits(1)}var i=""!==e.meter_unit?"__"+e.meter_unit:"";if(r.meter_volume_sent&&(e["meter_accumulated_volume"+i]=t.getUint64()/1e3),r.meter_volume_offset_sent&&(e["meter_accumulated_volume_offset"+i]=t.getInt32()/1e3),r.meter_nominal_flow_sent&&(e["meter_nominal_flow"+i]=t.getUint16()/10),r.alert_backflow_sent){var o=t.getUint16();e["alert_backflow_threshold"+i]=0===o?"disabled":o/1e3}if(r.alert_broken_pipe_sent){o=t.getUint32();e["alert_broken_pipe_threshold"+i]=0===o?"disabled":o/1e3}if(r.alert_continuous_flow_sent&&(e.alert_continuous_flow_enabled=Boolean(t.getUint8())),r.alert_no_usage_sent){o=t.getUint16();e.alert_no_usage_interval__days=0===o?"disabled":o}if(r.alert_tamper_sent&&(e.alert_tamper_enabled=Boolean(t.getUint8())),r.alert_temperature_sent){var s=t.getInt8();e.alert_temperature_threshold_low__C=-128===s?"disabled":s;var _=t.getInt8();e.alert_temperature_threshold_high__C=-128===_?"disabled":_}}function locationConfigurationParser(t,e){e._packet_type="location_configuration_packet";var r={},n=t.getUint8Bits();if(r.gps_position_sent=n.getBits(1),r.time_zone_sent=n.getBits(1),r.address_sent=n.getBits(1),r.id_customer_sent=n.getBits(1),r.id_location_sent=n.getBits(1),r.gps_position_sent&&(e.gps_position_latitude__deg=t.getInt32()/1e7,e.gps_position_longitude__deg=t.getInt32()/1e7),r.time_zone_sent&&(e.time_zone__h=t.getInt8()/4),r.address_sent){var a=t.getUint8();e.address=t.getTextUtf8(a)}if(r.id_customer_sent){var i=t.getUint8();e.id_customer=t.getTextUtf8(i)}if(r.id_location_sent){var o=t.getUint8();e.id_location=t.getTextUtf8(o)}}function configurationParser(t,e){var r=new BinaryExtract(t),n=r.getUint8();32===n?generalConfigurationParser(r,e):33===n?locationConfigurationParser(r,e):e._error=["invalid_configuration_type "+n]}function configurationRequestsParser(t,e){var r=new BinaryExtract(t).getUint8();32===r?e._packet_type="general_configuration_request":33===r?e._packet_type="location_configuration_request":e._error=["invalid_request_type "+r]}function commandParser(t,e){var r=new BinaryExtract(t),n=r.getUint8();if(3===n){if(1===t.length)return void(e._packet_type="local_time_request");e._packet_type="local_time_response",e.device_local_time__s=r.getUint32();var a=new Date(1e3*e.device_local_time__s);e.device_local_time_formatted=a.toISOString().replace(/.\d+Z$/g,"Z");e.device_local_time__s<1577836800&&(e.device_local_time_formatted="invalid")}else 255===n?e._packet_type="enter_dfu_command":e._error=["invalid_command_type "+n]}function sysMessagesParser(t,e){var r=new BinaryExtract(t),n=r.getUint8();if(19===n)e._packet_type="faulty_downlink_packet",e.packet_fport=r.getUint8(),e.packet_error_reason=packetErrorReasonFormatter(r.getUint8());else if(0===n){e._packet_type="boot_packet",e.device_serial=serialFormat(r.getUint32()),e.device_firmware_version=r.getUint8().toString()+"."+r.getUint8()+"."+r.getUint8();var a=r.getUint8Bits(),i={};i.reason_0=a.getBits(1),i.watchdog_reset=a.getBits(1),i.soft_reset=a.getBits(1),i.reason_3=a.getBits(1),i.magnet_wakeup=a.getBits(1),i.reason_5=a.getBits(1),i.reason_6=a.getBits(1),i.nfc_wakeup=a.getBits(1),e.wakeup_reason_mcu=wakeupReasonFormat(i);var o=r.getUint8Bits();o.getBits(4),e.packet_reason=bootPacketReason(o.getBits(3)),e.configuration_restored=o.getBits(1),e.hardware_configuration=hardwareConfigFormat(r.getUint8()),r.getUint8(),r.getUint8(),e.device_uptime_accumulated__days=parseFloat((r.getUint24()/24).toFixed(2))}else if(1===n){var s=shutdownEeasonFormat(r.getUint8());usageParser(t.slice(2),e),e._packet_type="shutdown_packet",e._shutdown_reason=s}else e._error=["invalid_command_type "+n]}function checkFport(t,e,r){t!==e&&(r._error=["wrong fport or header"])}function decodeByPacketHeader(t,e,r){return 0===e.length?r._error=["empty_payload"]:4===e[0]?(usageParser(e,r),checkFport(t,25,r)):32===e[0]||33===e[0]?1===e.length?(configurationRequestsParser(e,r),checkFport(t,49,r)):(configurationParser(e,r),checkFport(t,50,r)):3===e[0]||255===e[0]?(commandParser(e,r),checkFport(t,60,r)):0===e[0]||1===e[0]||19===e[0]?(sysMessagesParser(e,r),checkFport(t,99,r)):r._error=["invalid_header"],r}function decodeRaw(t,e){var r={};try{decodeByPacketHeader(t,e,r)}catch(t){r._error=[t.message]}for(var n in r._raw_payload=bytesToHexStr(e),r)"string"==typeof r[n]&&r[n].indexOf("invalid_")>-1&&("_error"in r||(r._error=[]),r._error.push(r[n]));return r}function _extract_unit_from_key(t){var e=t.split("__"),r=e.length>1?e[1]:"";return"C"==r&&(r=r.replace("C","°C")),r=(r=(r=r.replaceAll("_","/")).replace("3","³")).replace("deg","°")}function formatElementStrValueUnit(t,e,r,n){if(r)return r;var a=e.toString();n.length>0&&(isNaN(+a)||(a=a+" "+n));return a.replaceAll("_"," ")}function convertToFormatted(t,e,r){var n=r?[]:{},a=r?[]:{};for(var i in t)if(!(i.split("_formatted").length>1)){var o=i.split("__")[0],s=t[i],_=null;o+"_formatted"in t&&(_=t[o+"_formatted"]);var u=_extract_unit_from_key(i),c=o;is_hidden_param="_"==c[0],is_hidden_param&&(c=c.slice(1)),element=e(c,s,_,u),is_hidden_param?r?a.push(element):a[o]=element:r?n.push(element):n[o]=element}return{hidden:a,data:n}}function decodeDownlink(t){return convertToFormatted(decodeRaw(t.fPort,t.bytes),formatElementStrValueUnit,!1)}function decodeUplink(t){return convertToFormatted(decodeRaw(t.fPort,t.bytes),formatElementStrValueUnit,!1)}function Decoder(t,e){return convertToFormatted(decodeRaw(e,t),formatElementStrValueUnit,!1)}function Decode(t,e){return convertToFormatted(decodeRaw(t,e),formatElementStrValueUnit,!1)}BitExtract.prototype._assertOnRemainingLength=function(t){if(0===t)throw Error("invalid zero length bit field");if(this.offset+t>8)throw Error("invalid number of bits extracted")},BitExtract.prototype.getBits=function(t){this._assertOnRemainingLength(t);var e=Math.pow(2,t)-1,r=this.data>>this.offset&e;return this.offset+=t,1==t?Boolean(r):r},BinaryExtract.prototype.availableLen=function(){return this.buffer.length-this.offset},BinaryExtract.prototype._assertOnRemainingLength=function(t){if(t>this.availableLen())throw Error("invalid buffer length: too short")},BinaryExtract.prototype.getUint8=function(){return this._assertOnRemainingLength(1),this.buffer[this.offset++]},BinaryExtract.prototype.getInt8=function(){var t=this.getUint8();return t>127?t-256:t},BinaryExtract.prototype.getUint16=function(){return this._assertOnRemainingLength(2),this.buffer[this.offset++]+256*this.buffer[this.offset++]},BinaryExtract.prototype.getInt16=function(){var t=this.getUint16();return t>32767?t-65536:t},BinaryExtract.prototype.getUint24=function(){return this._assertOnRemainingLength(3),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]},BinaryExtract.prototype.getUint32=function(){return this._assertOnRemainingLength(4),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]+16777216*this.buffer[this.offset++]},BinaryExtract.prototype.getInt32=function(){var t=this.getUint32();return t>2147483647?t-4294967296:t},BinaryExtract.prototype.getUint64=function(){return this.getUint32()+4294967296*this.getUint32()},BinaryExtract.prototype.getTextUtf8=function(t){this._assertOnRemainingLength(t);var e=stringFromUTF8Array(this.buffer.slice(this.offset,this.offset+t));return this.offset+=t,e},BinaryExtract.prototype.getUint8Bits=function(){return new BitExtract(this.getUint8())},BinaryExtract.prototype.getRaw=function(t){this._assertOnRemainingLength(t);var e=this.buffer.slice(this.offset,this.offset+t);return this.offset+=t,e},BinaryExtract.prototype.getFloat=function(){var t=this.getUint32(),e=2147483648&t?-1:1,r=(t>>23&255)-127,n=8388607&t;if(128==r)return e*(n?Number.NaN:Number.POSITIVE_INFINITY);if(-127==r){if(0==n)return 0*e;r=-126,n/=1<<22}else n=(n|1<<23)/(1<<23);return e*n*Math.pow(2,r)};
