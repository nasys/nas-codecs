function stringFromUTF8Array(e){for(var t=[1,1,1,1,2,2,3,0],r=e.length,n="",a=0;a<r;){var i=e[a++];if(128&i){var o=t[i>>3&7];if(!(64&i)||!o||a+o>r)return null;for(i&=63>>o;o>0;o-=1){var s=e[a++];if(128!=(192&s))return null;i=i<<6|63&s}}n+=String.fromCharCode(i)}return n}function BitExtract(e){this.data=e,this.offset=0}function BinaryExtract(e){this.buffer=e,this.offset=0}function pad(e,t){for(var r=""+e;r.length<t;)r="0"+r;return r}function intToHexStr(e,t){return pad(e.toString(16).toUpperCase(),t)}function objToList(e){var t=[];for(var r in e)void 0!==e[r]&&e[r]&&t.push(r);return t}function ln(e){return e&&e.length||0}function sNc(e,t){return t>0?Array(t+1).join(e):""}function sIn(e,t,r){return t?e.slice(0,t)+r+e.slice(t):r+e}function p10(e,t){if(!t)return e;var r=ln(e);if(!r){var n=parseInt(e);if(e!==n)return isNaN(n)?e:e*Math.pow(10,t)}var a=""+e,i=(r?"-"==r.charAt(0):e<0)?1:0,o=ln(a);return t>0?a+=sNc("0",t):((t+=o-i)<0&&(a=sIn(a,i,sNc("0",-t))),a=sIn(a,t<=0?i:t+i,".")),r?a:Number(a)}function ha2si(e){var t,r,n=ln(e=e.slice()),a=[],i=e[n-1],o=128&i;if(o)for(t=r=0;t<n;++t)(e[t]||r)&&(e[t]=256-e[t]-r,r=1);for(t=n,r=0;t;)e[--t]&&(r=1);if(!r)return 0;do{for(i=r=0,t=n;t;){var s=256*i+e[--t];i=s%10,(e[t]=(s-i)/10)&&(r=1)}a.push(i)}while(r);for(t=ln(a);!a[--t];);return(o?"-":"")+a.slice(0,++t).reverse().join("")}function i2s(e,t){var r=e?e.toString():"0",n=ln(r);return t?(n<t?sNc("0",t-n):"")+r:r}function sum(e,t,r){for(var n=0,a=t||0;a<(r||ln(e));)n+=e[a++];return 255&n}function parseHs(e){for(var t,r=e?e.split(/[\s,]/):[],n=[],a=0;a<ln(r);)ln(t=r[a++])&&(n=n.concat(t.match(/.{1,2}/g)));return n}function hs2i(e){return Number("0x"+e.replace(/^#/,""))}function hs2a(e){for(var t,r=parseHs(e),n=[],a=0;a<ln(r);){if(t=hs2i(r[a++]),isNaN(t)||t<0||t>255)throw'"'+r[a]+'" is not a hex byte, pos '+a;n.push(t)}return n}function b2hs(e){return((e=Number(e))<16?"0":"")+e.toString(16)}function ba2i(e){var t=ln(e);if(!t||t>4)return t?e:0;for(var r=e[--t],n=3==t?0:128&r?(r&=127,-(1<<8*t+7)):0;t>0;)r=(r<<8)+e[--t];return r+n}function ba2b(e){for(var t=ln(e),r=0;t;)r=(r<<8)+e[--t];return r}function ba2bcd(e,t){var r,n,a,i=0,o=ln(e),s="",u=0,c=0;function l(e){c&&(e=-e),e<10?s+=e:(u=1,s+="A-C EF".charAt(e-10))}for(;o;)n=(240&(r=e[--o]))>>4,a=15&r,c&&(n=-n,a=-a),i=100*i+10*n+a,l(n),1==ln(s)&&(u=0,13==n?u=1:n>13&&(c=1,i=a=-a,14==n&&(i-=10))),l(a);if(!t&&u)throw s;return u?s:i}function i2c(e){return String.fromCharCode(e)}function ba2s(e){for(var t=[],r=ln(e);r;)t.push(i2c(e[--r]));return t.join("")}function date(e,t,r){return{rawY:e,y:1900+e+(e<100?100:0),m:t,d:r,toString:function(){var e=this,n=i2s(r,2)+"."+i2s(t,2)+"."+e.y;return void 0!==e.hr&&(n+=" "+i2s(e.hr,2)+":"+i2s(e.mi,2)+(void 0!==e.se?":"+i2s(e.se,2):"")),e.s&&(n+=" (summer)"),e.i&&(n+=" (invalid)"),n}}}function i2d(e){return e?date(e>>5&7|e>>9&120,e>>8&15,31&e):null}function i2t(e){var t=ln(e)||0,r=t>5?1:0,n=r?e[--t]:0;if(!(e=t?ba2b(e.slice(r,t)):e))return null;var a=i2d(e>>16);return a.hr=e>>8&31,a.mi=63&e,r&&(a.se=63&n),32768&e&&(a.s=!0),128&e&&(a.i=!0),a}function ba2f(e){var t=ln(e)-1,r=7;if(7==t)r=4;else if(3!=t)return NaN;var n,a=t-1,i=(1<<r)-1,o=(e[a]&i)<<8*a,s=1<<8*a+r,u=1<<14-r,c=(e[a]>>r)+((127&e[t])<<8-r)+1-u,l=e[t]>>7?-1:1;for(n=0;n<a;++n)o+=e[n]<<8*n;return c==u?l*(o?NaN:Number.POSITIVE_INFINITY):(o&&(o=c==1-u?o/(s>>1):(o|s)/s),l*o*Math.pow(2,c))}function tmbus(e){for(var t=hs2a(e),r=Array.isArray,n=[0],a="Manufacturer specific",i="Reserved",o="Units for H.C.A.";ln(t)&&255==t[0];)t.splice(0,1);var s,u,c=ln(t),l=c-2,_={len:c},f=0,d=0;if(!c)return _;function m(e){throw(e||"Wrong frame length")+", pos "+d}function p(){return d==c&&m(),s=t[d++]}function g(e,r){var n=d,a=r+d;return a>l&&m("Premature end of data when reading "+e+" (need "+r+", available "+(l-d)+")"),d=a,t.slice(n,d)}function h(e,t,r){var n=g(e,r||4);return t?ba2i(2==t?n.reverse():n):ba2bcd(n,1)}function v(e){sum(t,e,l)!=t[l]&&m("Check sum failed")}if(p(),1==c)return 229==s?_.type="OK":m("Invalid char"),_;if(c<5&&m(),22!=t[c-1]&&m("No Stop"),16==s)return _.type="Short",v(1),_.c=p(),_.a=p(),_;if(104!=s&&m("No Start"),_.type="Data",_.l=p(),t[2]!=s&&m("Invalid length"),t[0]!=t[3]&&m("Invalid format"),s!=c-6&&m("Wrong length"),v(d=4),_.c=p(),_.a=p(),_.ci=p(),u=_.errors=[],114==(250&s))_.fixed=1==(1&s);else{_.type="Error";var y=["Unspecified error","Unimplemented CI-Field","Buffer too long, truncated","Too many records","Premature end of record","More than 10 DIFE's","More than 10 VIFE's",i,"Application too busy for handling readout request","Too many readouts"];if(112==s)return u.push(y[d==l?0:p()<10?s:7]),_;m(y[1])}_.id=h("ID");var b=" meter",w=["Heat"+b,"Cooling"+b," (Volume measured at ","return temperature: outlet)","flow temperature: inlet)","Customer unit","Radio converter ","Access Code "],B=["Other","Oil"+b,"Electricity"+b,"Gas"+b,w[0],"Steam"+b,"Hot water"+b,"Water"+b,"Heat Cost Allocator",i,w[0]+w[2]+w[3],"Compressed air",w[1]+w[2]+w[3],w[1]+w[2]+w[4],w[0]+w[2]+w[4],"Combined Heat / "+w[1],"Bus / System component","Unknown device type","Cold water"+b,"Dual water"+b,"Pressure"+b+" / pressure device","A/D Converter","Warm water"+b,"Calorific value","Smoke detector / smoke alarm device","Room sensor","Gas detector","Consumption"+b,"Sensor","Breaker (electricity)","Valve (gas or water)","Switching device",w[5]+" (display device)",w[5],"Waste water"+b,"Garbage","Carbon dioxide","Environmental"+b,"System device","Communication controller","Unidirectional repeater","Bidirectional repeater",w[6]+"(system side)",w[6]+"(meter side)","Wired Adapter"],k=[0,1,2,3,4,5,6,7,8,9,3,4,5,6,7,8,9],U=[0,1,2,3,10,5,22,7,8,11,12,13,14,15,16,17,27,27,27,27,23,6,18,19,20,21,24,25,26,28,28,28,29,30,31,31,31,32,33,33,34,35,36,37,37,37,37,37,38,39,40,41,38,38,42,43,44],F=["Instantaneous","Maximum","Minimum","During error state"];function x(e){return e<2?[["h,m,s","D,M,Y"][e],0]:e<56?[["Wh","kWh","MWh","kJ","MJ","GJ","W","kW","MW","kJ/h","MJ/h","GJ/h","ml","l","m³","ml/h","l/h","m³/h"][Math.floor((e-2)/3)],(e-2)%3]:e<57?["°C",-3]:e<58?[o,0]:[i,0]}function E(e){return i2c(64+(31&e))}function C(e){return E(e>>10)+E(e>>5)+E(e)}function I(e){return B[e>63?9:e>56?38:U[e]]}function T(e){var t=e.status;return e.fixed?e.cStored=2&t?"At fixed date":"Actual":3!=(3&t)&&(1&t&&u.push("Application Busy"),2&t&&u.push("Application Error")),4&t&&u.push("Power Low"),8&t&&u.push("Permanent Error"),16&t&&u.push("Temporary Error"),1&t}function A(){_.data||(_.data=[]);var e={id:f++};return _.data.push(e),e}function P(e,t){_.deviceCode=e,_.deviceType=t}function M(e){var r=ln(e);for(r=r?e[r-1]:128;d<l&&r>>7;)r=t[d++],e.push(r);return e}var S=["Reserved","Energy","Volume","Mass","On Time","Operating Time","Power","Volume Flow","Volume Flow ext.","Mass flow","Flow Temperature","Return Temperature","Temperature Difference","External Temperature","Pressure","Time Point",o,"Averaging Duration","Actuality Duration","Credit","Debit","Access Number","Medium","Manufacturer","Parameter set id","Model/Version","Hardware version #","Firmware version #","Software version #","Customer location","Customer",w[7]+"User",w[7]+"Operator",w[7]+"System Operator",w[7]+"Developer","Password","Error flags","Error mask","Digital Output","Digital Input","Baudrate","Response delay time","Retry","First cyclic storage #","Last cyclic storate #","Storage block size","Storage interval","Duration since last readout","Start of tariff","Duration of tariff","Period of tariff","Voltage","Current","Dimensionless","Reset counter","Cumulation counter","Control signal","Day of week","Week number","Time point of day change","State of parameter activation","Special supplier information","Duration since last cumulation","Operating time battery","Battery change","Cold/Warm Temperature Limit","Cumul. count max power"],D=["seconds","minutes","hours","days","months","years","Wh","J","m³","kg","W","J/h","m³/h","m³/min","m³/s","kg/h","°C","K","bar","currency unit","binary","baud","bittimes","V","A","MWh","GJ","t","feet³","american gallon","american gallon/min","american gallon/h","MW","GJ/h","°F","revolution / measurement","liter","kWh","kW","K*l"];function R(e,t,r){e.type=S[t[0]];var n=t[1];ln(t)>1&&(5==n&&(n=9,r+=2),9==n?e.unit=D[r]:8==n?(e.type+=" ("+(r?"time & ":"")+"date)",e.f=1==r?i2t:i2d):n>5?e.f=7==n?I:C:(e.unit=D[t[2]],e.e=r+t[1]))}function N(e,t){var a=t>>2&15,i=3&t;64&t&&(a=16+(7&a));var o=t>112?n:[[19,-3,19],[20,-3,19],[[21],[22,7],[23,6],[24]],[[25],[26],[27],[28]],[[29],[30],[31],[32]],[[33],[34],[35],[36,0,20]],[[37],n,[38,0,20],[39,0,20]],[[40,0,21],[41,0,22],[42],n],[[43],[44],[45],n],[46,9],[[46,0,4],[46,0,5],n,n],[47,9],[[48,8],[49,0,1],[49,0,2],[49,0,3]],[50,9],[[50,0,4],[50,0,5],[53],n],n,[[54],[55],[56],[57]],[[58],[59],[60],[61]],[62,5],[63,5],[[64,8]]][a];64==(96&t)?(i=15&t,o=(a=16&t)?[52,-12,24]:[51,-9,23]):r(o[0])&&(o=o[i],i=0),R(e,o,i)}function L(e,t){for(var a=7&t,i=[[[[1,-1,25]]],[[[1,-1,26]]],[[[2,2,8]]],[[[3,2,27]]],[[[n,[2,-1,28]],[[2,-1,29],[2,0,29]]],[[[7,-3,30],[7,0,30]],[[7,0,31],n]]],[[[6,-1,32]]],[[[6,-1,33]]],n,n,n,n,[[10,-3,34],[11,-3,34]],[[12,-3,34],[13,-3,34]],n,[[65,-3,34],[65,-3,16]],[66,-3,10]][t>>3&15],o=2;r(i[0]);a&=15^1<<o,i=t>>o--&1?ln(i)<1?n:i[1]:i[0]);R(e,i,a)}function O(e,t){var r,n=7&t,i="per ",o="multiplied by sek",s=2&n?"out":"in",u=8&t?"upper":"lower",c=4&t?"last":"first",l=1&t?"end":"begin",_="Duration of ",f=" limit exceed";(r=t<2?t?"Too many DIFE's":r:t<8?["Storage number","Unit number","Tariff number","Function","Data class","Data size"][n-2]+" not implemented":t<11?r:t<16?["Too many VIFE's","Illegal VIF-Group","Illegal VIF-Exponent","VIF/DIF mismatch","Unimplemented action"][n-3]:t<21?r:t<25?["No data available (undefined value)","Data overflow","Data underflow","Data error"][n-5]:t<28?"Premature end of record":t<32?r:t<39?i+D[n].slice(0,-1):t<40?i+D[35]:t<44?"increment per "+s+"put pulse on "+s+"put channel #"+(1&t):t<54?i+D[[36,8,9,17,37,26,38,39,23,24][t-44]]:t<55?o:t<57?o+" / "+D[24-(1&t)]:t<61?["start date(/time) of","VIF contains uncorrected unit instead of corrected unit","Accumulation only if positive contributions","Accumulation of abs value only if negative contributions"][n-1]:t<64?S[0]:t<74?n?"# of exceeds of "+u+" limit":u+" limit value":t<80?"Date (/time) of: "+l+" of "+c+" "+u+f:t<96?_+c+" "+u+f+", "+D[3&n]:t<104?_+c+", "+D[3&n]:t<112?2&n?"Date (/time) of "+c+" "+l:r:t<120?(e.e=n-6,r):t<124?"Additive correction constant: 10E"+(n-3)+"*"+e.type+" (offset)":t<125?r:t<126?(e.e=3,r):["future value",a+" data next"][1&n])&&e.typeE.push(r)}function V(e){var i,o=e.vif,s=ln(o),u=0,c=o[u],l=127,_=c&l;if(253==c||251==c?(253==c?N:L)(e,_=o[++u]&l):_<124?function(e,t){var a=t>>3&15,i=7&t,o=[[1,-3,6],[1,1,7],[2,-6,8],[3,-3,9],[[4,9],[5,9]],[6,-3,10],[6,1,11],[7,-6,12],[8,-7,13],[8,-9,14],[9,-3,15],[[10,-3,16],[11,-3,16]],[[12,-3,17],[13,-3,16]],[[14,-3,18],[[15,8],[[16],n]]],[[17,9],[18,9]]];if(15==a)i<3&&(e.type=["Fabrication No","(Enhanced)","Bus Address"][i]);else{for(var s=o[a],u=2;r(s[0]);i&=15^1<<u,s=s[t>>u--&1]);R(e,s,i)}}(e,_):124==_&&(i=t[(d-=s-2)-1],e.type=ba2s(g("VIF type",i)),s=ln(o=e.vif=M([c]))),_==l&&(e.type=a),o[u]>>7){for(_!=l&&++u,e.typeE=[],i=0;u<s&&u<11&&(_=(c=o[u++])&l,i?e.typeE.push(_):(i=_==l,O(e,_)),128&c););ln(e.typeE)||delete e.typeE}}function W(e){V(e);var r,n,a,i,o,s=e.dif,u=ln(s)-1,c=s[0],l=c>>4&3,_=15&c,f=7&c;if(13==_?(r=f=t[d++],f<192?a=ba2s:(f&=15,r>239?r<251&&(a=ba2f):(a=r>223?ba2i:ba2bcd,o=208==(240&r)))):5==f?(--f,a=ba2f):(7==f&&++f,a=8&_?ba2bcd:ba2i),n=_=g("Record #"+e.id,f),a)try{_=a(_)}catch(t){e.error=!0,_=t}if(e.error||(e.f&&(_=e.f(_)),(a=Array.isArray(_))&&(_=ha2si(_)),o&&(_=a?"-"==_.charAt(0)?_.slice(1):"-"+_:-_),e.e&&(_=p10(_,e.e))),e.value=_,e.rawValue=n,e.func=F[l],l=1&(c>>=6),n=_=i=0,2&c){for(;n<u;++n)i+=((c=s[n+1])>>6&1)<<n,_+=(c>>4&3)<<2*n,l+=(15&c)<<4*n+1;e.device=i,e.tariff=_}e.storage=l,delete e.f,delete e.e}return _.fixed?function(){_.accessN=p(),_.status=p();var e=T(_),t=p(),r=p(),n=t>>6|r>>4&12;P(n,B[k[n]]),n>9&&n<15&&e&&(e=2);var a,i=A(),o=A(),s=x(63&t),u=63&r,c=1;i.storage=0,i.func=F[0],i.value=p10(h("Counter 1",e),s[1]),i.unit=s[0],62==u?a=s:(c=0,63!=u&&(a=x(u))),o.storage=c,o.func=F[0],c=h("Counter 2",e),o.value=a?p10(c,a[1]):c,o.unit=a?a[0]:""}():function(){for(_.manId=C(h("ManID",1,2)),_.version=p(),p(),P(s,I(s)),_.accessN=p(),_.status=p(),T(_),d+=2;d<l-1;){var e=t[d],r=47==e?r:A();15==(15&e)?(++d,(e=e>>4&7)<2?(e&&(r.request="Readout again"),r.type=a,r.value=g(r.type,l-d)):e>6&&(r.request="Global readout")):(r.dif=M([]),r.vif=M([]),W(r))}}(),_}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){s=!0,i=e},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw i}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function _ba2hs(e,t){for(var r=[],n=0;n<ln(e);)r.push(b2hs(e[n++]));return r.join(t||"")}function invoke_tmbus(e){var t=ln(e)+21,r=[104,t-6,t-6,104,8,2,114,120,86,52,18,36,64,1,7,85,0,0,0].concat(Array.from(e)),n=sum(r,4,t-2);r.push(n,22);var a=tmbus(_ba2hs(r));return{data:a.data,errors:a.errors}}function convert_units(e){return e=(e=(e=(e=(e=e.replace(/\s+/g,"")).replace(" ","_")).replace("/","_per_")).replace("³","3")).replace("°","deg")}function convert_time_to_iso(e){var t=e.y+"-"+pad(e.m,2)+"-"+pad(e.d,2);return e.hr&&(t+="T"+pad(e.hr,2)+":"+pad(e.mi,2)),t}function convert_datarecords(e){var t,r={},n=_createForOfIteratorHelper(e);try{for(n.s();!(t=n.n()).done;){var a=t.value,i=a.storage,o="";i>0&&(o="storage"+i+"_");var s=a.type.replace(/\s+/g,"_").replace(/_\(.*?\)/g,""),u="";if(a.typeE)for(var c=0;c<a.typeE.length;c++)if(a.typeE[c]&&""!==a.typeE[c].trim()){var l=a.typeE[c],_={"VIF contains uncorrected unit":"_VIF","Accumulation only if positive contributions":"_accumulated_pos","Accumulation of abs value only if negative contributions":"_Accumulated_neg"};for(var f in _)l=l.replace(f,_[f]);console.log("Value ".concat(c+1,": ").concat(l)),u=l}var d="";a.func&&(d={Instantaneous:"",Maximum:"_max",Minimum:"_min","During error state":"_during_error"}[a.func]);var m="";a.tariff&&(m="tariff"+a.tariff+"_");var p="";a.device&&(p="subunit"+a.device+"_");var g=a.value;a.type.includes("Time Point")&&(g=convert_time_to_iso(g));var h="";if(a.unit&&(h="__"+convert_units(a.unit),"binary"==a.unit)){var v=15&a.dif[0];g="0x"+intToHexStr(a.value,2*v)}var y=[o,p,m,s,u,d].filter((function(e){return void 0!==e})).join("").toLowerCase();y=y.replace("__","_"),r[y+=h]=g}}catch(e){n.e(e)}finally{n.f()}return r}function decode_mbus(e){return convert_datarecords(invoke_tmbus(e).data)}function meterStatusFormat(e,t){switch(e){case 0:return"connected";case 1:return"no_response";case 2:case 4:return"protocol_error";case 3:return"meter_damaged";case 5:return"bus_shorted";default:return t.errors.push("invalid_status"),"invalid_status"}}function meterMultiplierConvert(e){return e<3||e>7?-1:Math.pow(10,e-6)}function meterMediumFormat(e,t){switch(e){case 0:return"water";case 1:return"warm_water";case 2:return"gas";default:return t.errors.push("invalid_medium"),"invalid_medium"}}function meterUnitFormat(e,t){switch(e){case 0:return"m3";case 1:return"gal";case 2:return"ft3";default:return t.errors.push("invalid_unit"),"invalid_unit"}}function serialFormat(e){return 4294967295===e?"not_available":intToHexStr(e,8)}function actualityDurationToMinutesFormat(e){return e<60?e:e<156?15*(e-60):e<200?24*(e-156)*60:e<253?7*(e-200)*24*60:253===e?525600:null}function actualityDurationToFormatStr(e){var t=actualityDurationToMinutesFormat(e);return e<60?t+" minutes":e<156?(t/60).toFixed(2)+" hours":e<200?(t/1440).toFixed(2)+" days":e<253?(t/10080).toFixed(2)+" weeks":253===e?(t/525600).toFixed(2)+" years":null}function multiplierToExponent(e){switch(e){case.001:return-3;case.01:return-2;case.1:return-1;case 1:return 0;case 10:return 1;default:throw Error("invalid_multiplier")}}function volumeFormatUnit(e,t){var r=multiplierToExponent(t),n=pad((r>0?e:e/t).toFixed(0),r>0?8+r:8);return r<0&&(n=n.substring(0,8+r)+"."+n.substring(8+r)),n}function lorawanProfileFormat(e,t){switch(e){case 0:return"lorawan_disabled";case 1:return"lorawan_24_h_privacy";case 2:return"lorawan_24_h";case 3:return"lorawan_12_h";case 7:return"lorawan_1_h_static";case 8:return"lorawan_15_min_static";case 23:return"lorawan_1_h_dynamic";case 24:return"lorawan_15_min_dynamic";default:return t.errors.push("invalid_lorawan_profile"),"invalid_lorawan_profile"}}function wmbusProfileFormat(e,t){switch(e){case 0:return"wmbus_disabled";case 1:return"wmbus_privacy";case 2:return"wmbus_driveby";case 3:return"wmbus_fixnet";default:return t.errors.push("invalid_wmbus_profile"),"invalid_wmbus_profile"}}function packetErrorReasonFormatter(e){switch(e){case 0:case 1:return"n/a";case 2:return"unknown_fport";case 3:return"packet_size_short";case 4:return"packet_size_long";case 5:return"value_error";case 6:return"protocol_parse_error";case 7:return"reserved_flag_set";case 8:return"invalid_flag_combination";case 9:return"unavailable_feature_request";case 10:return"unsupported_header";case 11:return"unreachable_hw_request";case 12:return"address_not_available";case 13:return"internal_error";default:return"invalid_error_code"}}function hardwareConfigFormat(e,t){switch(e){case 0:return"Modularis";case 1:return"Cyble";case 2:return"Falcon_PR";case 3:return"Picoflux";case 4:return"Falcon_MJ";case 6:return"RCM_LMx";case 32:return"BK_G";default:return t.errors.push("invalid_hardware_config"),"invalid_hardware_config"}}function shutdownReasonFormat(e,t){switch(e){case 16:return"calibration_timeout";case 49:return"magnet_shutdown";case 50:return"enter_dfu";case 51:return"app_shutdown";case 52:return"switch_to_wmbus";default:return t.errors.push("invalid_shutdown_reason"),"invalid_shutdown_reason"}}function bootPacketReason(e,t){switch(e){case 0:return"unknown_reset";case 1:return"from_shutdown";case 2:return"from_dfu";case 3:return"froced_reset";case 4:return"lorawan_rejoin";default:return t.errors.push("invalid_packet_reason"),"invalid_packet_reason"}}function usageParser(e,t,r){t.packet_type="usage_packet";var n={},a=e.getUint8Bits();n.backflow_pending=a.getBits(1),n.broken_pipe_pending=a.getBits(1),n.continuous_flow_pending=a.getBits(1),n.tamper_pending=a.getBits(1),n.temperature_pending=a.getBits(1),n.low_battery=a.getBits(1),n.no_usage=a.getBits(1),t.active_alerts=n,t.meter_status=meterStatusFormat(e.getUint8(),r);var i=e.getUint8Bits();if(t.meter_multiplier=meterMultiplierConvert(i.getBits(3)),t.meter_multiplier<0)r.errors.push("invalid_multiplier");else{t.meter_medium=meterMediumFormat(i.getBits(2),r),t.meter_unit=meterUnitFormat(i.getBits(2),r);var o=i.getBits(1),s=e.getUint8();if(t.meter_actuality_duration__minutes=actualityDurationToMinutesFormat(s),t.meter_actuality_duration_formatted=actualityDurationToFormatStr(s),t["meter_accumulated_volume__"+t.meter_unit]=volumeFormatUnit(t.meter_multiplier*e.getUint32(),t.meter_multiplier),o){var u=e.getUint8Bits(),c=u.getBits(5),l=u.getBits(3),_=e.getUint8Bits(),f=_.getBits(4),d=2e3+l+8*_.getBits(4),m=new Date;m.setUTCFullYear(d),m.setUTCMonth(f,c),m.setUTCDate(c),t.meter_readout_date=m.toISOString().split(/[T ]/i,1)[0]}var p=e.getUint8Bits();if(t.app_connected_within_a_day=p.getBits(1),p.getBits(1)){t.battery_remaining__years=parseFloat((e.getUint8()/12).toFixed(1)),t.battery_voltage__V=parseFloat((e.getUint8()/100+1.5).toFixed(2)),t.internal_temperature__C=e.getInt8();var g=e.getUint8Bits();t.internal_temperature_min__C=-2*g.getBits(4)+t.internal_temperature__C,t.internal_temperature_max__C=2*g.getBits(4)+t.internal_temperature__C,t.radio_downlink_rssi__dBm=-1*e.getUint8();var h=e.getUint8Bits();t.radio_downlink_snr__dB=2*h.getBits(4)-20,t.radio_uplink_power__dBm=2*h.getBits(4),t.meter_serial=serialFormat(e.getUint32())}}}function generalConfigurationParser(e,t,r){t.packet_type="general_configuration_packet";var n={},a=e.getUint8Bits();n.radio_lorawan_profile_sent=a.getBits(1),n.radio_wmbus_profile_sent=a.getBits(1),n.meter_serial_sent=a.getBits(1),n.meter_multiplier_sent=a.getBits(1),n.meter_volume_sent=a.getBits(1),n.meter_volume_offset_sent=a.getBits(1),n.meter_nominal_flow_sent=a.getBits(1),n.alert_backflow_sent=a.getBits(1);var i=e.getUint8Bits();n.alert_broken_pipe_sent=i.getBits(1),n.alert_continuous_flow_sent=i.getBits(1),n.alert_no_usage_sent=i.getBits(1),n.alert_tamper_sent=i.getBits(1),n.alert_temperature_sent=i.getBits(1),n.radio_lorawan_profile_sent&&(t.radio_lorawan_profile=lorawanProfileFormat(e.getUint8(),r)),n.radio_wmbus_profile_sent&&(t.radio_wmbus_profile=wmbusProfileFormat(e.getUint8(),r)),n.meter_serial_sent&&(t.meter_serial=serialFormat(e.getUint32()));var o="",s="";if(n.meter_multiplier_sent){var u=e.getUint8Bits();t.meter_multiplier=meterMultiplierConvert(u.getBits(3)),t.meter_medium=meterMediumFormat(u.getBits(2),r),t.meter_unit=meterUnitFormat(u.getBits(2),r),s=(o=""!==t.meter_unit?"__"+t.meter_unit:"")?o+"_per_h":"",t.privacy_mode_active=u.getBits(1)}if(n.meter_volume_sent&&(t["meter_accumulated_volume"+o]=e.getUint64()/1e3),n.meter_volume_offset_sent&&(t["meter_accumulated_volume_offset"+o]=e.getInt32()/1e3),n.meter_nominal_flow_sent&&(t["meter_nominal_flow"+s]=e.getUint16()/10),n.alert_backflow_sent){var c=e.getUint16();t.alert_backflow_threshold=0===c?"disabled":c/1e3}if(n.alert_broken_pipe_sent){var l=e.getUint32();t["alert_broken_pipe_threshold"+s]=0===l?"disabled":l/1e3}if(n.alert_continuous_flow_sent&&(t.alert_continuous_flow_enabled=Boolean(e.getUint8())),n.alert_no_usage_sent){var _=e.getUint16();t.alert_no_usage_interval__days=0===_?"disabled":_}if(n.alert_tamper_sent&&(t.alert_tamper_enabled=Boolean(e.getUint8())),n.alert_temperature_sent){var f=e.getInt8();t.alert_temperature_threshold_low__C=-128===f?"disabled":f;var d=e.getInt8();t.alert_temperature_threshold_high__C=-128===d?"disabled":d}}function locationConfigurationParser(e,t){t.packet_type="location_configuration_packet";var r={},n=e.getUint8Bits();if(r.gps_position_sent=n.getBits(1),r.time_zone_sent=n.getBits(1),r.address_sent=n.getBits(1),r.id_customer_sent=n.getBits(1),r.id_location_sent=n.getBits(1),r.gps_position_sent&&(t.gps_position_latitude__deg=e.getInt32()/1e7,t.gps_position_longitude__deg=e.getInt32()/1e7),r.time_zone_sent&&(t.time_zone__h=e.getInt8()/4),r.address_sent){var a=e.getUint8();t.address=e.getTextUtf8(a)}if(r.id_customer_sent){var i=e.getUint8();t.id_customer=e.getTextUtf8(i)}if(r.id_location_sent){var o=e.getUint8();t.id_location=e.getTextUtf8(o)}}function configurationParser(e,t,r,n){32===t?generalConfigurationParser(e,r,n):33===t?locationConfigurationParser(e,r):n.errors.push("invalid_configuration_type "+t)}function configurationRequestsParser(e,t){32===packet_type?e.packet_type="general_configuration_request":33===packet_type?e.packet_type="location_configuration_request":t.errors.push("invalid_request_type "+packet_type)}function commandParser(e,t,r,n){if(3===t){if(1===e.availableLen())return void(r.packet_type="local_time_request");r.packet_type="local_time_response",r.device_local_time__s=e.getUint32();var a=new Date(1e3*r.device_local_time__s);r.device_local_time_formatted=a.toISOString().replace(/.\d+Z$/g,"Z");r.device_local_time__s<1577836800&&(r.device_local_time_formatted="invalid")}else 255===t?r.packet_type="enter_dfu_command":n.errors.push("invalid_command_type "+t)}function sysMessagesParser(e,t,r,n){if(19===t)r.packet_type="faulty_downlink_packet",r.packet_fport=e.getUint8(),r.packet_error_reason=packetErrorReasonFormatter(e.getUint8()),n.warnings.push("faulty_downlink_packet "+r.packet_error_reason);else if(0===t){r.packet_type="boot_packet",r.device_serial=serialFormat(e.getUint32()),r.device_firmware_version=e.getUint8().toString()+"."+e.getUint8()+"."+e.getUint8();var a=e.getUint8Bits(),i={};i.reason_0=a.getBits(1),i.watchdog_reset=a.getBits(1),i.soft_reset=a.getBits(1),i.reason_3=a.getBits(1),i.magnet_wakeup=a.getBits(1),i.reason_5=a.getBits(1),i.reason_6=a.getBits(1),i.nfc_wakeup=a.getBits(1),r.wakeup_reason_mcu=objToList(i);var o=e.getUint8Bits();o.getBits(4),r.packet_reason=bootPacketReason(o.getBits(3),n),r.configuration_restored=o.getBits(1),r.hardware_configuration=hardwareConfigFormat(e.getUint8(),n),e.getUint8(),e.getUint8(),r.device_uptime_accumulated__days=parseFloat((e.getUint24()/24).toFixed(2))}else if(1===t){var s=shutdownReasonFormat(e.getUint8(),n);4!==e.getUint8()&&n.errors.push("no_usage_header_found"),usageParser(e,r,n),r.packet_type="shutdown_packet",r.shutdown_reason=s}else n.errors.push("invalid_sys_msg_type "+t)}function omsParser(e,t,r,n){if(122==t){r.packet_type="oms_usage_packet",r.header_access_num=e.getUint8(),r.header_status=e.getUint8(),r.header_packet_synchronous=8192===e.getUint16();var a=decode_mbus(e.getRaw(e.availableLen()));for(var i in a)r["oms_"+i]=a[i]}}function checkFport(e,t,r){e!==t&&r.errors.push("wrong fport or header")}function decodeByPacketHeader(e,t,r,n){var a=new BinaryExtract(t);if(0===a.availableLen())return n.errors.push("empty_payload"),r;var i=a.getUint8();return 4===i?(usageParser(a,r,n),checkFport(e,25,n)):32===i||33===i?1===t.length?(configurationRequestsParser(i,r),checkFport(e,49,n)):(configurationParser(a,i,r,n),checkFport(e,50,n)):3===i||255===i?(commandParser(a,i,r,n),checkFport(e,60,n)):0===i||1===i||19===i?(sysMessagesParser(a,i,r,n),checkFport(e,99,n)):122===i||114==i?(omsParser(a,i,r),checkFport(e,20,n)):n.errors.push("invalid_packet_type"),a.availableLen()>0&&n.errors.push("packet_too_long"),r}function decodeRaw(e,t){var r={},n={errors:[],warnings:[]};try{decodeByPacketHeader(e,t,r,n)}catch(e){n.errors.push("decoder_error "+e.message)}return{data:r,errors:n.errors,warnings:n.warnings}}function decodeDownlink(e){return decodeRaw(e.fPort,e.bytes)}function decodeUplink(e){return decodeRaw(e.fPort,e.bytes)}function Decoder(e,t){return decodeRaw(t,e)}function Decode(e,t){return decodeRaw(e,t)}BitExtract.prototype._assertOnRemainingLength=function(e){if(0===e)throw Error("invalid zero length bit field");if(this.offset+e>8)throw Error("invalid number of bits extracted")},BitExtract.prototype.getBits=function(e){this._assertOnRemainingLength(e);var t=Math.pow(2,e)-1,r=this.data>>this.offset&t;return this.offset+=e,1===e?Boolean(r):r},BinaryExtract.prototype.availableLen=function(){return this.buffer.length-this.offset},BinaryExtract.prototype._assertOnRemainingLength=function(e){if(e>this.availableLen())throw Error("invalid buffer length: too short")},BinaryExtract.prototype.getUint8=function(){return this._assertOnRemainingLength(1),this.buffer[this.offset++]},BinaryExtract.prototype.getInt8=function(){var e=this.getUint8();return e>127?e-256:e},BinaryExtract.prototype.getUint16=function(){return this._assertOnRemainingLength(2),this.buffer[this.offset++]+256*this.buffer[this.offset++]},BinaryExtract.prototype.getInt16=function(){var e=this.getUint16();return e>32767?e-65536:e},BinaryExtract.prototype.getUint24=function(){return this._assertOnRemainingLength(3),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]},BinaryExtract.prototype.getUint32=function(){return this._assertOnRemainingLength(4),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]+16777216*this.buffer[this.offset++]},BinaryExtract.prototype.getInt32=function(){var e=this.getUint32();return e>2147483647?e-4294967296:e},BinaryExtract.prototype.getUint64=function(){return this.getUint32()+4294967296*this.getUint32()},BinaryExtract.prototype.getTextUtf8=function(e){this._assertOnRemainingLength(e);var t=stringFromUTF8Array(this.buffer.slice(this.offset,this.offset+e));return this.offset+=e,t},BinaryExtract.prototype.getUint8Bits=function(){return new BitExtract(this.getUint8())},BinaryExtract.prototype.getRaw=function(e){this._assertOnRemainingLength(e);var t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},BinaryExtract.prototype.getFloat=function(){var e=this.getUint32(),t=2147483648&e?-1:1,r=(e>>23&255)-127,n=8388607&e;if(128===r)return t*(n?Number.NaN:Number.POSITIVE_INFINITY);if(-127===r){if(0===n)return 0*t;r=-126,n/=1<<22}else n=(n|1<<23)/(1<<23);return t*n*Math.pow(2,r)};
