function stringFromUTF8Array(t){for(var e=[1,1,1,1,2,2,3,0],r=t.length,n="",i=0;i<r;){var a=t[i++];if(128&a){var o=e[a>>3&7];if(!(64&a)||!o||i+o>r)return null;for(a&=63>>o;o>0;o-=1){var s=t[i++];if(128!=(192&s))return null;a=a<<6|63&s}}n+=String.fromCharCode(a)}return n}function BitExtract(t){this.data=t,this.offset=0}function BinaryExtract(t){this.buffer=t,this.offset=0}function pad(t,e){for(var r=""+t;r.length<e;)r="0"+r;return r}function intToHexStr(t,e){return pad(t.toString(16).toUpperCase(),e)}function objToList(t){var e=[];for(var r in t)void 0!==t[r]&&t[r]&&e.push(r);return e}function meterStatusFormat(t,e){switch(t){case 0:return"connected";case 1:return"no_response";case 2:case 4:return"protocol_error";case 3:return"meter_damaged";case 5:return"bus_shorted";default:return e.errors.push("invalid_status"),"invalid_status"}}function meterMultiplierConvert(t){return t<3||t>7?-1:10**(t-6)}function meterMediumFormat(t,e){switch(t){case 0:return"water";case 1:return"warm_water";case 2:return"gas";default:return e.errors.push("invalid_medium"),"invalid_medium"}}function meterUnitFormat(t,e){switch(t){case 0:return"m3";case 1:return"gal";case 2:return"ft3";default:return e.errors.push("invalid_unit"),"invalid_unit"}}function serialFormat(t){return 4294967295===t?"not_available":intToHexStr(t,8)}function actualityDurationToMinutesFormat(t){return t<60?t:t<156?15*(t-60):t<200?24*(t-156)*60:t<253?7*(t-200)*24*60:253===t?525600:null}function actualityDurationToFormatStr(t){var e=actualityDurationToMinutesFormat(t);return t<60?e+" minutes":t<156?(e/60).toFixed(2)+" hours":t<200?(e/1440).toFixed(2)+" days":t<253?(e/10080).toFixed(2)+" weeks":253===t?(e/525600).toFixed(2)+" years":null}function multiplierToExponent(t){switch(t){case.001:return-3;case.01:return-2;case.1:return-1;case 1:return 0;case 10:return 1;default:throw Error("invalid_multiplier")}}function volumeFormatUnit(t,e){var r=multiplierToExponent(e),n=pad((r>0?t:t/e).toFixed(0),r>0?8+r:8);return r<0&&(n=n.substring(0,8+r)+"."+n.substring(8+r)),n}function lorawanProfileFormat(t,e){switch(t){case 0:return"lorawan_disabled";case 1:return"lorawan_24_h_privacy";case 2:return"lorawan_24_h";case 3:return"lorawan_12_h";case 7:return"lorawan_1_h_static";case 8:return"lorawan_15_min_static";case 23:return"lorawan_1_h_dynamic";case 24:return"lorawan_15_min_dynamic";default:return e.errors.push("invalid_lorawan_profile"),"invalid_lorawan_profile"}}function wmbusProfileFormat(t,e){switch(t){case 0:return"wmbus_disabled";case 1:return"wmbus_privacy";case 2:return"wmbus_driveby";case 3:return"wmbus_fixnet";default:return e.errors.push("invalid_wmbus_profile"),"invalid_wmbus_profile"}}function packetErrorReasonFormatter(t){switch(t){case 0:case 1:return"n/a";case 2:return"unknown_fport";case 3:return"packet_size_short";case 4:return"packet_size_long";case 5:return"value_error";case 6:return"protocol_parse_error";case 7:return"reserved_flag_set";case 8:return"invalid_flag_combination";case 9:return"unavailable_feature_request";case 10:return"unsupported_header";case 11:return"unreachable_hw_request";case 12:return"address_not_available";case 13:return"internal_error";default:return"invalid_error_code"}}function hardwareConfigFormat(t,e){switch(t){case 0:return"Modularis";case 1:return"Cyble";case 2:return"Falcon_PR";case 3:return"Picoflux";case 4:return"Falcon_MJ";case 6:return"RCM_LMx";case 32:return"BK_G";default:return e.errors.push("invalid_hardware_config"),"invalid_hardware_config"}}function shutdownReasonFormat(t,e){switch(t){case 16:return"calibration_timeout";case 49:return"magnet_shutdown";case 50:return"enter_dfu";case 51:return"app_shutdown";case 52:return"switch_to_wmbus";default:return e.errors.push("invalid_shutdown_reason"),"invalid_shutdown_reason"}}function bootPacketReason(t,e){switch(t){case 0:return"unknown_reset";case 1:return"from_shutdown";case 2:return"from_dfu";case 3:return"froced_reset";case 4:return"lorawan_rejoin";default:return e.errors.push("invalid_packet_reason"),"invalid_packet_reason"}}function usageParser(t,e,r){var n=new BinaryExtract(t),i=n.getUint8();if(4===i){e._packet_type="usage_packet";var a={},o=n.getUint8Bits();a.backflow_pending=o.getBits(1),a.broken_pipe_pending=o.getBits(1),a.continuous_flow_pending=o.getBits(1),a.tamper_pending=o.getBits(1),a.temperature_pending=o.getBits(1),a.low_battery=o.getBits(1),a.no_usage=o.getBits(1),e.active_alerts=objToList(a),e.meter_status=meterStatusFormat(n.getUint8(),r);var s=n.getUint8Bits();if(e._meter_multiplier=meterMultiplierConvert(s.getBits(3)),e._meter_multiplier<0)r.errors.push("invalid_multiplier");else{e._meter_medium=meterMediumFormat(s.getBits(2),r),e._meter_unit=meterUnitFormat(s.getBits(2),r);var _=s.getBits(1),u=n.getUint8();if(e.meter_actuality_duration__minutes=actualityDurationToMinutesFormat(u),e.meter_actuality_duration_formatted=actualityDurationToFormatStr(u),e["meter_accumulated_volume__"+e._meter_unit]=volumeFormatUnit(e._meter_multiplier*n.getUint32(),e._meter_multiplier),_){var c=n.getUint8Bits(),l=c.getBits(5),f=c.getBits(3),g=n.getUint8Bits(),m=g.getBits(4),d=2e3+f+8*g.getBits(4),p=new Date;p.setUTCFullYear(d),p.setUTCMonth(m),p.setUTCDate(l),e.meter_readout_date=p.toISOString().split(/[T ]/i,1)[0]}var h=n.getUint8Bits();if(e._app_connected_within_a_day=h.getBits(1),h.getBits(1)){e.battery_remaining__years=parseFloat((n.getUint8()/12).toFixed(1)),e._battery_voltage__V=n.getUint8()/100+1.5,e.internal_temperature__C=n.getInt8();var v=n.getUint8Bits();e._internal_temperature_min__C=-2*v.getBits(4)+e.internal_temperature__C,e._internal_temperature_max__C=2*v.getBits(4)+e.internal_temperature__C,e.radio_downlink_rssi__dBm=-1*n.getUint8();var w=n.getUint8Bits();e._radio_downlink_snr__dB=2*w.getBits(4)-20,e._radio_uplink_power__dBm=2*w.getBits(4),e.meter_serial=serialFormat(n.getUint32())}}}else r.errors.push("invalid_packet_type "+i)}function generalConfigurationParser(t,e,r){e._packet_type="general_configuration_packet";var n={},i=t.getUint8Bits();n.radio_lorawan_profile_sent=i.getBits(1),n.radio_wmbus_profile_sent=i.getBits(1),n.meter_serial_sent=i.getBits(1),n.meter_multiplier_sent=i.getBits(1),n.meter_volume_sent=i.getBits(1),n.meter_volume_offset_sent=i.getBits(1),n.meter_nominal_flow_sent=i.getBits(1),n.alert_backflow_sent=i.getBits(1);var a=t.getUint8Bits();if(n.alert_broken_pipe_sent=a.getBits(1),n.alert_continuous_flow_sent=a.getBits(1),n.alert_no_usage_sent=a.getBits(1),n.alert_tamper_sent=a.getBits(1),n.alert_temperature_sent=a.getBits(1),n.radio_lorawan_profile_sent&&(e.radio_lorawan_profile=lorawanProfileFormat(t.getUint8(),r)),n.radio_wmbus_profile_sent&&(e.radio_wmbus_profile=wmbusProfileFormat(t.getUint8(),r)),n.meter_serial_sent&&(e.meter_serial=serialFormat(t.getUint32())),e.meter_unit="",n.meter_multiplier_sent){var o=t.getUint8Bits();e.meter_multiplier=meterMultiplierConvert(o.getBits(3)),e.meter_medium=meterMediumFormat(o.getBits(2),r),e.meter_unit=meterUnitFormat(o.getBits(2),r),e.privacy_mode_active=o.getBits(1)}var s=""!==e.meter_unit?"__"+e.meter_unit:"";if(n.meter_volume_sent&&(e["meter_accumulated_volume"+s]=t.getUint64()/1e3),n.meter_volume_offset_sent&&(e["meter_accumulated_volume_offset"+s]=t.getInt32()/1e3),n.meter_nominal_flow_sent&&(e["meter_nominal_flow"+s]=t.getUint16()/10),n.alert_backflow_sent){var _=t.getUint16();e["alert_backflow_threshold"+s]=0===_?"disabled":_/1e3}if(n.alert_broken_pipe_sent){var u=t.getUint32();e["alert_broken_pipe_threshold"+s]=0===u?"disabled":u/1e3}if(n.alert_continuous_flow_sent&&(e.alert_continuous_flow_enabled=Boolean(t.getUint8())),n.alert_no_usage_sent){var c=t.getUint16();e.alert_no_usage_interval__days=0===c?"disabled":c}if(n.alert_tamper_sent&&(e.alert_tamper_enabled=Boolean(t.getUint8())),n.alert_temperature_sent){var l=t.getInt8();e.alert_temperature_threshold_low__C=-128===l?"disabled":l;var f=t.getInt8();e.alert_temperature_threshold_high__C=-128===f?"disabled":f}}function locationConfigurationParser(t,e){e._packet_type="location_configuration_packet";var r={},n=t.getUint8Bits();if(r.gps_position_sent=n.getBits(1),r.time_zone_sent=n.getBits(1),r.address_sent=n.getBits(1),r.id_customer_sent=n.getBits(1),r.id_location_sent=n.getBits(1),r.gps_position_sent&&(e.gps_position_latitude__deg=t.getInt32()/1e7,e.gps_position_longitude__deg=t.getInt32()/1e7),r.time_zone_sent&&(e.time_zone__h=t.getInt8()/4),r.address_sent){var i=t.getUint8();e.address=t.getTextUtf8(i)}if(r.id_customer_sent){var a=t.getUint8();e.id_customer=t.getTextUtf8(a)}if(r.id_location_sent){var o=t.getUint8();e.id_location=t.getTextUtf8(o)}}function configurationParser(t,e,r){var n=new BinaryExtract(t),i=n.getUint8();32===i?generalConfigurationParser(n,e,r):33===i?locationConfigurationParser(n,e):r.errors.push("invalid_configuration_type "+i)}function configurationRequestsParser(t,e,r){var n=new BinaryExtract(t).getUint8();32===n?e._packet_type="general_configuration_request":33===n?e._packet_type="location_configuration_request":r.errors.push("invalid_request_type "+n)}function commandParser(t,e,r){var n=new BinaryExtract(t),i=n.getUint8();if(3===i){if(1===t.length)return void(e._packet_type="local_time_request");e._packet_type="local_time_response",e.device_local_time__s=n.getUint32();var a=new Date(1e3*e.device_local_time__s);e.device_local_time_formatted=a.toISOString().replace(/.\d+Z$/g,"Z");e.device_local_time__s<1577836800&&(e.device_local_time_formatted="invalid")}else 255===i?e._packet_type="enter_dfu_command":r.errors.push("invalid_command_type "+i)}function sysMessagesParser(t,e,r){var n=new BinaryExtract(t),i=n.getUint8();if(19===i)e._packet_type="faulty_downlink_packet",e.packet_fport=n.getUint8(),e.packet_error_reason=packetErrorReasonFormatter(n.getUint8()),r.warnings.push("faulty_downlink_packet: "+e.packet_error_reason);else if(0===i){e._packet_type="boot_packet",e.device_serial=serialFormat(n.getUint32()),e.device_firmware_version=n.getUint8().toString()+"."+n.getUint8()+"."+n.getUint8();var a=n.getUint8Bits(),o={};o.reason_0=a.getBits(1),o.watchdog_reset=a.getBits(1),o.soft_reset=a.getBits(1),o.reason_3=a.getBits(1),o.magnet_wakeup=a.getBits(1),o.reason_5=a.getBits(1),o.reason_6=a.getBits(1),o.nfc_wakeup=a.getBits(1),e.wakeup_reason_mcu=objToList(o);var s=n.getUint8Bits();s.getBits(4),e.packet_reason=bootPacketReason(s.getBits(3),r),e.configuration_restored=s.getBits(1),e.hardware_configuration=hardwareConfigFormat(n.getUint8(),r),n.getUint8(),n.getUint8(),e.device_uptime_accumulated__days=parseFloat((n.getUint24()/24).toFixed(2))}else if(1===i){var _=shutdownReasonFormat(n.getUint8(),r);usageParser(t.slice(2),e,r),e._packet_type="shutdown_packet",e._shutdown_reason=_}else r.errors.push("invalid_sys_msg_type "+i)}function checkFport(t,e,r){t!==e&&r.errors.push("wrong fport or header")}function decodeByPacketHeader(t,e,r,n){return 0===e.length?n.errors.push("empty_payload"):4===e[0]?(usageParser(e,r,n),checkFport(t,25,n)):32===e[0]||33===e[0]?1===e.length?(configurationRequestsParser(e,r,n),checkFport(t,49,n)):(configurationParser(e,r,n),checkFport(t,50,n)):3===e[0]||255===e[0]?(commandParser(e,r,n),checkFport(t,60,n)):0===e[0]||1===e[0]||19===e[0]?(sysMessagesParser(e,r,n),checkFport(t,99,n)):n.errors.push("invalid_header"),r}function decodeRaw(t,e){var r={},n={errors:[],warnings:[]};try{decodeByPacketHeader(t,e,r,n)}catch(t){n.errors.push(t.message)}var i={data:r};return n.errors.length&&(i.errors=n.errors),n.warnings.length&&(i.warnings=n.warnings),i}function extractUnitFromKey(t){var e=t.split("__"),r=e.length>1?e[1]:"";return"C"===r&&(r=r.replace("C","°C")),r=(r=(r=r.replace("_","/")).replace("3","³")).replace("deg","°")}function formatElementStrValueUnit(t,e,r,n){if(r)return r;var i=e.toString();n.length>0&&(isNaN(+i)||(i=i+" "+n));return i.split("_").join(" ")}function convertToFormatted(t,e,r){var n=t.data,i=r?[]:{};for(var a in n)if(!(a.split("_formatted").length>1)){var o=a.split("__")[0],s=n[a],_=null;o+"_formatted"in n&&(_=n[o+"_formatted"]);var u=extractUnitFromKey(a),c=o;"_"===o[0]&&(c=c.slice(1));var l=e(c,s,_,u);r?i.push(l):i[c]=l}return t.data=i,t}function decodeDownlink(t){return convertToFormatted(decodeRaw(t.fPort,t.bytes),formatElementStrValueUnit,!1)}function decodeUplink(t){return convertToFormatted(decodeRaw(t.fPort,t.bytes),formatElementStrValueUnit,!1)}function Decoder(t,e){return convertToFormatted(decodeRaw(e,t),formatElementStrValueUnit,!1)}function Decode(t,e){return convertToFormatted(decodeRaw(t,e),formatElementStrValueUnit,!1)}BitExtract.prototype._assertOnRemainingLength=function(t){if(0===t)throw Error("invalid zero length bit field");if(this.offset+t>8)throw Error("invalid number of bits extracted")},BitExtract.prototype.getBits=function(t){this._assertOnRemainingLength(t);var e=2**t-1,r=this.data>>this.offset&e;return this.offset+=t,1===t?Boolean(r):r},BinaryExtract.prototype.availableLen=function(){return this.buffer.length-this.offset},BinaryExtract.prototype._assertOnRemainingLength=function(t){if(t>this.availableLen())throw Error("invalid buffer length: too short")},BinaryExtract.prototype.getUint8=function(){return this._assertOnRemainingLength(1),this.buffer[this.offset++]},BinaryExtract.prototype.getInt8=function(){var t=this.getUint8();return t>127?t-256:t},BinaryExtract.prototype.getUint16=function(){return this._assertOnRemainingLength(2),this.buffer[this.offset++]+256*this.buffer[this.offset++]},BinaryExtract.prototype.getInt16=function(){var t=this.getUint16();return t>32767?t-65536:t},BinaryExtract.prototype.getUint24=function(){return this._assertOnRemainingLength(3),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]},BinaryExtract.prototype.getUint32=function(){return this._assertOnRemainingLength(4),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]+16777216*this.buffer[this.offset++]},BinaryExtract.prototype.getInt32=function(){var t=this.getUint32();return t>2147483647?t-4294967296:t},BinaryExtract.prototype.getUint64=function(){return this.getUint32()+4294967296*this.getUint32()},BinaryExtract.prototype.getTextUtf8=function(t){this._assertOnRemainingLength(t);var e=stringFromUTF8Array(this.buffer.slice(this.offset,this.offset+t));return this.offset+=t,e},BinaryExtract.prototype.getUint8Bits=function(){return new BitExtract(this.getUint8())},BinaryExtract.prototype.getRaw=function(t){this._assertOnRemainingLength(t);var e=this.buffer.slice(this.offset,this.offset+t);return this.offset+=t,e},BinaryExtract.prototype.getFloat=function(){var t=this.getUint32(),e=2147483648&t?-1:1,r=(t>>23&255)-127,n=8388607&t;if(128===r)return e*(n?Number.NaN:Number.POSITIVE_INFINITY);if(-127===r){if(0===n)return 0*e;r=-126,n/=1<<22}else n=(n|1<<23)/(1<<23);return e*n*2**r};
