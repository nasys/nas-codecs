function stringFromUTF8Array(t){for(var e=[1,1,1,1,2,2,3,0],r=t.length,n="",a=0;a<r;){var i=t[a++];if(128&i){var s=e[i>>3&7];if(!(64&i)||!s||a+s>r)return null;for(i&=63>>s;s>0;s-=1){var o=t[a++];if(128!=(192&o))return null;i=i<<6|63&o}}n+=String.fromCharCode(i)}return n}function BitExtract(t){this.data=t,this.offset=0}function BinaryExtract(t){this.buffer=t,this.offset=0}function pad(t,e){for(var r=""+t;r.length<e;)r="0"+r;return r}function intToHexStr(t,e){return pad(t.toString(16).toUpperCase(),e)}function objToList(t){var e=[];for(var r in t)void 0!==t[r]&&t[r]&&e.push(r);return e}function mbusStatus(t,e){switch(t){case 0:return"connected";case 1:return"nothing_requested";case 2:return"bus_unpowered";case 3:return"no_response";case 5:return"crc_or_len_error";case 6:return"parse_error";case 7:return"bus_shorted";default:return e.errors.push("invalid_mbus_status"),"invalid_mbus_status"}}function usagePulseMediumType(t,e){switch(t){case 0:return"triggers";case 1:return"pulses";case 2:return"L_water";case 3:return"Wh_electricity";case 4:return"L_gas";default:return e.errors.push("invalid_medium"),"invalid_medium"}}function serialFormat(t){return 4294967295===t?"not_available":intToHexStr(t,8)}function actualityDurationToMinutesFormat(t){return t<60?t:t<156?15*(t-60):t<200?24*(t-156)*60:t<253?7*(t-200)*24*60:253===t?525600:null}function actualityDurationToFormatStr(t){var e=actualityDurationToMinutesFormat(t);return t<60?e+" minutes":t<156?(e/60).toFixed(2)+" hours":t<200?(e/1440).toFixed(2)+" days":t<253?(e/10080).toFixed(2)+" weeks":253===t?(e/525600).toFixed(2)+" years":null}function usagePulseMultiplier(t){switch(t){case 0:return 1;case 1:return 10;case 2:return 100;case 3:return 1e3;default:throw Error("invalid_multiplier")}}function pulseInputModeAndUnit(t,e){switch(t){case 0:return"disabled";case 1:return"pulses";case 2:return"L_water";case 3:return"Wh_electricity";case 4:return"L_gas";case 9:return"triggers_1_sec";case 10:return"triggers_10_sec";case 11:return"triggers_1_min";case 12:return"triggers_1_h";default:throw e.errors.push("invalid_input_mode"),Error("invalid_input_mode")}}function lorawanProfileFormat(t,e){switch(t){case 0:return"lorawan_disabled";case 1:return"lorawan_24_h_privacy";case 2:return"lorawan_24_h";case 3:return"lorawan_12_h";case 7:return"lorawan_1_h_static";case 8:return"lorawan_15_min_static";case 23:return"lorawan_1_h_dynamic";case 24:return"lorawan_15_min_dynamic";default:return e.errors.push("invalid_lorawan_profile"),"invalid_lorawan_profile"}}function wmbusProfileFormat(t,e){switch(t){case 0:return"wmbus_disabled";case 1:return"wmbus_privacy";case 2:return"wmbus_driveby";case 3:return"wmbus_fixnet";default:return e.errors.push("invalid_wmbus_profile"),"invalid_wmbus_profile"}}function packetErrorReasonFormatter(t,e){switch(t){case 0:case 1:return"n/a";case 2:return"unknown_fport";case 3:return"packet_size_short";case 4:return"packet_size_long";case 5:return"value_error";case 6:return"protocol_parse_error";case 7:return"reserved_flag_set";case 8:return"invalid_flag_combination";case 9:return"unavailable_feature_request";case 10:return"unsupported_header";case 11:return"unreachable_hw_request";case 12:return"address_not_available";case 13:return"internal_error";default:return e.errors.push("invalid_error_code"),"invalid_error_code"}}function hardwareConfigFormat(t,e){switch(t){case 0:return"pulse_only";case 1:return"pulse_analog";case 2:return"pulse_ssi";case 4:return"pulse_mbus";case 6:return"pulse_lbus";case 7:return"pulse_izar";default:return e.errors.push("invalid_hardware_config"),"invalid_hardware_config"}}function shutdownReasonFormat(t,e){switch(t){case 50:return"enter_dfu";case 51:return"app_shutdown";case 52:return"switch_to_wmbus";default:return e.errors.push("invalid_shutdown_reason"),"invalid_shutdown_reason"}}function bootPacketReason(t,e){switch(t){case 0:return"unknown_reset";case 1:return"from_shutdown";case 2:return"from_dfu";case 3:return"froced_reset";case 4:return"lorawan_rejoin";default:return e.errors.push("invalid_boot_packet_reason"),"invalid_boot_packet_reason"}}function mbusMedium(t){switch(t){case 0:return"other";case 1:return"oil";case 2:return"electricity";case 3:return"gas";case 4:return"heat (outlet vol)";case 5:return"steam";case 6:return"hot Water";case 7:return"water";case 8:return"heat cost allocator";case 9:return"compressed air";case 10:case 11:return"cooling load meter";case 12:return"heat (inlet vol)";case 13:return"heat / cooling load meter";case 14:return"bus / system";case 15:default:return"unknown";case 22:return"cold water";case 23:return"dual water";case 24:return"pressure";case 25:return"A/D converter"}}function mbusManufacturer(t){var e=String.fromCharCode(64+(t>>10&31));return e+=String.fromCharCode(64+(t>>5&31)),e+=String.fromCharCode(64+(31&t))}function ssiSensor(t,e){switch(t){case 0:return"disconnected";case 1:return"pressure_30bar_temperature";default:return e.errors.push("unknown_sensor_index"),"unknown_sensor_index"}}function pulseUsageParse(t,e,r,n){var a=e.getUint8Bits();r[t+"_input_state"]=!0===a.getBits(1)?"closed":"open";var i=a.getBits(1),s=usagePulseMultiplier(a.getBits(2));r["_"+t+"_muliplier"]=s;var o=usagePulseMediumType(a.getBits(4),n);r["_"+t+"_medium_type"]=o,r[t+"_accumulated__"+o]=e.getUint32()*s,i&&(r[t+"_serial"]=serialFormat(e.getUint32()))}function usageAndStatusParser(t,e,r){var n=new BinaryExtract(t),a=!1,i=n.getUint8();if(2===i)e._packet_type="usage_packet";else{if(130!==i)return void r.errors.push("invalid_packet_type "+i);e._packet_type="status_packet",a=!0}var s=n.getUint8Bits(),o={};if(o.pulse_1_trigger_alert=s.getBits(1),o.pulse_2_trigger_alert=s.getBits(1),s.getBits(4),o.low_battery=s.getBits(1),e._app_connected_within_a_day=s.getBits(1),e.active_alerts=objToList(o),a){e.battery_remaining__years=parseFloat((n.getUint8()/12).toFixed(1)),e._battery_voltage__V=n.getUint8()/100+1.5,e.internal_temperature__C=n.getInt8();var u=n.getUint8Bits();e._internal_temperature_min__C=-2*u.getBits(4)+e.internal_temperature__C,e._internal_temperature_max__C=2*u.getBits(4)+e.internal_temperature__C,e.radio_downlink_rssi__dBm=-1*n.getUint8();var _=n.getUint8Bits();e._radio_downlink_snr__dB=2*_.getBits(4)-20,e._radio_uplink_power__dBm=2*_.getBits(4)}var c=n.getUint8();e.meter_actuality_duration__minutes=actualityDurationToMinutesFormat(c),e.meter_actuality_duration_formatted=actualityDurationToFormatStr(c);var l=n.getUint8Bits(),g=l.getBits(1),f=l.getBits(1),d=l.getBits(4),p=8===d,h=4===d;if(g&&pulseUsageParse("pulse_1",n,e,r),f&&pulseUsageParse("pulse_2",n,e,r),p){var m=n.getUint8Bits();for(e.mbus_last_status=mbusStatus(m.getBits(4),r),e._mbus_data_records_truncated=m.getBits(1),m.getBits(1)&&(e.mbus_status="0x"+intToHexStr(n.getUint8(),2),e.mbus_serial=serialFormat(n.getUint32())),e.mbus_data_records_unparsed="";n.offset<n.buffer.length;)e.mbus_data_records_unparsed+=intToHexStr(n.getUint8(),2)}if(h){var v=n.getUint8Bits();e.ssi_sensor=ssiSensor(v.getBits(6),r);var B=n.getUint8Bits(),y=B.getBits(1),w=B.getBits(1),b=B.getBits(1),U=B.getBits(1),F=B.getBits(1),k=B.getBits(1),x=B.getBits(1),P=B.getBits(1);y&&(e.ssi_channel_1=parseFloat(n.getFloat().toFixed(5))),w&&(e.ssi_channel_1_avg=parseFloat(n.getFloat().toFixed(5))),b&&(e.ssi_channel_2=parseFloat(n.getFloat().toFixed(5))),U&&(e.ssi_channel_2_avg=parseFloat(n.getFloat().toFixed(5))),F&&(e.ssi_channel_3=parseFloat(n.getFloat().toFixed(5))),k&&(e.ssi_channel_3_avg=parseFloat(n.getFloat().toFixed(5))),x&&(e.ssi_channel_4=parseFloat(n.getFloat().toFixed(5))),P&&(e.ssi_channel_4_avg=parseFloat(n.getFloat().toFixed(5)))}}function pulseConfigParse(t,e,r,n){r[t+"_input_mode_and_unit"]=pulseInputModeAndUnit(e.getUint8Bits().getBits(4),n);var a=e.getUint8Bits(),i=a.getBits(1),s=a.getBits(1),o=a.getBits(1),u=a.getBits(1);a.getBits(2);var _=usagePulseMultiplier(a.getBits(2));i&&(r[t+"_multiplier_numerator"]=e.getUint16(),r[t+"_multiplier_denominator"]=e.getUint8()),s&&(r[t+"_accumulated_absolute"]=e.getUint32()*_),o&&(r[t+"_accumulated_offset"]=e.getInt32()*_),u&&(r[t+"_serial"]=serialFormat(e.getUint32()))}function generalConfigurationParser(t,e,r){var n=new BinaryExtract(t),a=n.getUint8();if(18===a){e._packet_type="general_configuration_packet";var i=n.getUint8Bits(),s=i.getBits(1),o=i.getBits(1);i.getBits(2);var u=i.getBits(1),_=i.getBits(1);s&&(e.radio_lorawan_profile=lorawanProfileFormat(n.getUint8(),r)),o&&(e.radio_wmbus_profile=wmbusProfileFormat(n.getUint8(),r)),u&&pulseConfigParse("pulse_1",n,e,r),_&&pulseConfigParse("pulse_2",n,e,r)}else r.errors.push("invalid_configuration_type "+a)}function mbusConfigurationParser(t,e,r){var n=new BinaryExtract(t),a=n.getUint8();if(20===a){e._packet_type="mbus_configuration_packet";var i=n.getUint8Bits(),s=i.getBits(4),o=i.getBits(4);if(s>10||o>10)r.errors.push("invalid_usage_or_status_count");else for(e.mbus_data_record_headers_unparsed="";n.offset<n.buffer.length;)e.mbus_data_record_headers_unparsed+=intToHexStr(n.getUint8(),2)}else r.errors.push("invalid_configuration_type "+a)}function locationConfigurationParser(t,e,r){var n=new BinaryExtract(t),a=n.getUint8();if(33===a){e._packet_type="location_configuration_packet";var i={},s=n.getUint8Bits();if(i.gps_position_sent=s.getBits(1),i.time_zone_sent=s.getBits(1),i.address_sent=s.getBits(1),i.id_customer_sent=s.getBits(1),i.id_location_sent=s.getBits(1),i.gps_position_sent&&(e.gps_position_latitude__deg=n.getInt32()/1e7,e.gps_position_longitude__deg=n.getInt32()/1e7),i.time_zone_sent&&(e.time_zone__h=n.getInt8()/4),i.address_sent){var o=n.getUint8();e.address=n.getTextUtf8(o)}if(i.id_customer_sent){var u=n.getUint8();e.id_customer=n.getTextUtf8(u)}if(i.id_location_sent){var _=n.getUint8();e.id_location=n.getTextUtf8(_)}}else r.errors.push("invalid_configuration_type "+a)}function configurationRequestsParser(t,e,r){var n=new BinaryExtract(t).getUint8();18===n?e._packet_type="general_configuration_request":20===n?e._packet_type="mbus_configuration_request":33===n?e._packet_type="location_configuration_request":r.errors.push("invalid_request_type "+n)}function commandParser(t,e,r){var n=new BinaryExtract(t),a=n.getUint8();if(3===a){if(1===t.length)return void(e._packet_type="local_time_request");e._packet_type="local_time_response",e.device_local_time__s=n.getUint32();var i=new Date(1e3*e.device_local_time__s);e.device_local_time_formatted=i.toISOString().replace(/.\d+Z$/g,"Z");e.device_local_time__s<1577836800&&(e.device_local_time_formatted="invalid")}else if(129===a){if(1===t.length)return void(e._packet_type="mbus_available_data_records_request");var s=n.getUint8Bits();if(e._packet_number=s.getBits(3),e._more_packets_following=s.getBits(1),s.getBits(2),s.getBits(1)){e._packet_type="mbus_available_data_records",e.mbus_header_serial=serialFormat(n.getUint32()),e.mbus_header_manufacturer=mbusManufacturer(n.getUint16()),e.mbus_header_version="0x"+intToHexStr(n.getUint8(),2),e.mbus_header_medium=mbusMedium(n.getUint8()),e.mbus_header_access_number=n.getUint8(),e.mbus_header_status="0x"+intToHexStr(n.getUint8(),2);var o=intToHexStr(n.getUint8(),2),u=intToHexStr(n.getUint8(),2);e.mbus_header_signature=o+u}for(e.mbus_data_record_headers_unparsed="";n.offset<n.buffer.length;)e.mbus_data_record_headers_unparsed+=intToHexStr(n.getUint8(),2)}else 255===a?e._packet_type="enter_dfu_command":r.errors.push("invalid_command_type "+a)}function sysMessagesParser(t,e,r){var n=new BinaryExtract(t),a=n.getUint8();if(19===a)e._packet_type="faulty_downlink_packet",e.packet_fport=n.getUint8(),e.packet_error_reason=packetErrorReasonFormatter(n.getUint8(),r),r.warnings.push("faulty_downlink_packet: "+e.packet_error_reason);else if(0===a){e._packet_type="boot_packet",e.device_serial=serialFormat(n.getUint32()),e.device_firmware_version=n.getUint8().toString()+"."+n.getUint8()+"."+n.getUint8();var i=n.getUint8Bits(),s={};s.reason_0=i.getBits(1),s.watchdog_reset=i.getBits(1),s.soft_reset=i.getBits(1),s.reason_3=i.getBits(1),s.magnet_wakeup=i.getBits(1),s.reason_5=i.getBits(1),s.reason_6=i.getBits(1),s.nfc_wakeup=i.getBits(1),e.wakeup_reason_mcu=objToList(s);var o=n.getUint8Bits();o.getBits(4),e.packet_reason=bootPacketReason(o.getBits(3),r),e.configuration_restored=o.getBits(1),e.hardware_configuration=hardwareConfigFormat(n.getUint8(),r),e.device_uptime_accumulated__days=parseFloat((n.getUint24()/24).toFixed(2))}else if(1===a){var u=shutdownReasonFormat(n.getUint8(),r);usageAndStatusParser(t.slice(2),e),e._packet_type="shutdown_packet",e._shutdown_reason=u}else r.errors.push("invalid_command_type "+a)}function checkFport(t,e,r){t!==e&&r.errors.push("wrong fport or header")}function decodeByPacketHeader(t,e,r,n){0===e.length?n.errors.push("empty_payload"):2===e[0]?(usageAndStatusParser(e,r,n),checkFport(t,25,n)):130===e[0]?(usageAndStatusParser(e,r,n),checkFport(t,24,n)):18===e[0]?1===e.length?(configurationRequestsParser(e,r,n),checkFport(t,49,n)):(generalConfigurationParser(e,r,n),checkFport(t,50,n)):33===e[0]?1===e.length?(configurationRequestsParser(e,r,n),checkFport(t,49,n)):(locationConfigurationParser(e,r,n),checkFport(t,50,n)):20===e[0]?1===e.length?(configurationRequestsParser(e,r,n),checkFport(t,49,n)):(mbusConfigurationParser(e,r,n),checkFport(t,50,n)):3===e[0]||129===e[0]||255===e[0]?(commandParser(e,r,t),1===e.length||3===e[0]?checkFport(t,60,n):checkFport(t,61,n)):0===e[0]||1===e[0]||19===e[0]?(sysMessagesParser(e,r,n),checkFport(t,99,n)):n.errors.push("invalid_header")}function decodeRaw(t,e){var r={},n={errors:[],warnings:[]};try{decodeByPacketHeader(t,e,r,n)}catch(t){n.errors.push(t.message)}var a={data:r};return n.errors.length&&(a.errors=n.errors),n.warnings.length&&(a.warnings=n.warnings),a}function extractUnitFromKey(t){var e=t.split("__"),r=e.length>1?e[1]:"";return"C"===r&&(r=r.replace("C","°C")),r=(r=(r=r.replaceAll("_","/")).replace("3","³")).replace("deg","°")}function formatElementStrValueUnit(t,e,r,n){if(r)return r;var a=e.toString();n.length>0&&(isNaN(+a)||(a=a+" "+n));return a.replaceAll("_"," ")}function convertToFormatted(t,e,r){var n=r?[]:{},a=r?[]:{};for(var i in t)if(!(i.split("_formatted").length>1)){var s=i.split("__")[0],o=t[i],u=null;s+"_formatted"in t&&(u=t[s+"_formatted"]);var _=extractUnitFromKey(i),c=s,l="_"==c[0];l&&(c=c.slice(1));var g=e(c,o,u,_);l?r?a.push(g):a[s]=g:r?n.push(g):n[s]=g}return{hidden:a,data:n}}function decodeDownlink(t){return convertToFormatted(decodeRaw(t.fPort,t.bytes),formatElementStrValueUnit,!1)}function decodeUplink(t){return convertToFormatted(decodeRaw(t.fPort,t.bytes),formatElementStrValueUnit,!1)}function Decoder(t,e){return convertToFormatted(decodeRaw(e,t),formatElementStrValueUnit,!1)}function Decode(t,e){return convertToFormatted(decodeRaw(t,e),formatElementStrValueUnit,!1)}BitExtract.prototype._assertOnRemainingLength=function(t){if(0===t)throw Error("invalid zero length bit field");if(this.offset+t>8)throw Error("invalid number of bits extracted")},BitExtract.prototype.getBits=function(t){this._assertOnRemainingLength(t);var e=2**t-1,r=this.data>>this.offset&e;return this.offset+=t,1===t?Boolean(r):r},BinaryExtract.prototype.availableLen=function(){return this.buffer.length-this.offset},BinaryExtract.prototype._assertOnRemainingLength=function(t){if(t>this.availableLen())throw Error("invalid buffer length: too short")},BinaryExtract.prototype.getUint8=function(){return this._assertOnRemainingLength(1),this.buffer[this.offset++]},BinaryExtract.prototype.getInt8=function(){var t=this.getUint8();return t>127?t-256:t},BinaryExtract.prototype.getUint16=function(){return this._assertOnRemainingLength(2),this.buffer[this.offset++]+256*this.buffer[this.offset++]},BinaryExtract.prototype.getInt16=function(){var t=this.getUint16();return t>32767?t-65536:t},BinaryExtract.prototype.getUint24=function(){return this._assertOnRemainingLength(3),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]},BinaryExtract.prototype.getUint32=function(){return this._assertOnRemainingLength(4),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]+16777216*this.buffer[this.offset++]},BinaryExtract.prototype.getInt32=function(){var t=this.getUint32();return t>2147483647?t-4294967296:t},BinaryExtract.prototype.getUint64=function(){return this.getUint32()+4294967296*this.getUint32()},BinaryExtract.prototype.getTextUtf8=function(t){this._assertOnRemainingLength(t);var e=stringFromUTF8Array(this.buffer.slice(this.offset,this.offset+t));return this.offset+=t,e},BinaryExtract.prototype.getUint8Bits=function(){return new BitExtract(this.getUint8())},BinaryExtract.prototype.getRaw=function(t){this._assertOnRemainingLength(t);var e=this.buffer.slice(this.offset,this.offset+t);return this.offset+=t,e},BinaryExtract.prototype.getFloat=function(){var t=this.getUint32(),e=2147483648&t?-1:1,r=(t>>23&255)-127,n=8388607&t;if(128===r)return e*(n?Number.NaN:Number.POSITIVE_INFINITY);if(-127===r){if(0===n)return 0*e;r=-126,n/=1<<22}else n=(n|1<<23)/(1<<23);return e*n*2**r};
