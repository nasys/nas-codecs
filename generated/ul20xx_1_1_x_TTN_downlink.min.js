function BitPack(e){this.data_byte=0,this.offset=0,this.err=e}function BinaryPack(e){this.buffer=[],this.err=e}function strLookup(e,t,i){if("string"!=typeof e)return e;for(var a in t)if(a.toLowerCase()===e.toLowerCase())return t[a];return isNaN(parseFloat(e))&&i.warnings.push("invalid_value "+e),e}function addressEncode(e,t){var i=parseInt(e.replace(/\D/g,""));return"analog_0_10v"===e?1:"dali_broadcast"===e?254:"all_devices"===e?255:-1!==e.toLowerCase().indexOf("dali_group_")?2*i+128:-1!==e.toLowerCase().indexOf("dali_single_")?2*i:-1!==e.toLowerCase().indexOf("invalid")?(t.warnings.push("invaid_address"),"invaid_address"):void 0}function dimLevelEncode(e,t){if("disabled"===e)return 255;var i=parseInt(e);return isNaN(i)?(t.warnings.push("invalid_dim_value "+e),255):((i<0||i>100)&&t.warnings.push("out_of_range_dim_value "+e),i)}function convert_unix(e){return new Date(e).getTime()/1e3}function encode_deprecated_ldr_input_config(e,t,i){t.addUint8(1),t.addUint8(strLookup(e.ldr_off_threshold_high,{disabled:255},i),"ldr_off_threshold_high"),t.addUint8(strLookup(e.ldr_on_threshold_low,{disabled:255},i),"ldr_on_threshold_low");var a=new BitPack(i);a.addBits(0,2,""),a.addBit(e.trigger_alert_enabled,"trigger_alert_enabled"),t.addUint8(a.data_byte)}function zen_angle(e){return Math.round(6*(e-90))}function encode_deprecated_dig_input_config(e,t,i){t.addUint8(3),t.addUint16(strLookup(e.light_on_duration__s,{dig_input_disabled:65535},i),"light_on_duration__s");var a=new BitPack(e);a.addBit(0,""),a.addBit(e.signal_edge_rising,"signal_edge_rising"),a.addBit(e.trigger_alert_enabled,"trigger_alert_enabled"),t.addUint8(a.data_byte),t.addUint8(addressEncode(e.address,i)),t.addUint8(dimLevelEncode(e.dimming_level__percent,i),"dimming_level__percent")}function status_config(e,t,i){t.addUint8(7);var a=parseInt(e.status_interval__s);a<60?(i.warnings.push("status_interval_60s_minimum"),t.addUint32(60)):a>86400?(i.warnings.push("status_interval_86400s_maximum"),t.addUint8(86400)):t.addUint32(a,"status_interval__s")}function usage_config(e,t,i){t.addUint8(11);var a=strLookup(e.usage_interval__s,{disabled:0},i);t.addUint32(a,"usage_interval__s"),e.mains_voltage__v?t.addUint8(e.mains_voltage__v,mains_voltage__v):t.addUint8(255)}function time_config(e,t,i){t.addUint8(9);var a=strLookup(e.device_unix_epoch,{force_lorawan_devicetimereq:0},i);t.addUint32(convert_unix(a),"device_unix_epoch")}function boot_delay_config(e,t,i){t.addUint8(13),t.addUint16(e.boot_delay_range__s)}function onboard_led_config(e,t,i){t.addUint8(21);var a=new BitPack(i);a.addBit(e.status_led_enabled,"status_led_enabled"),t.addUint8(a.data_byte)}function metering_alert_config(e,t,i){t.addUint8(22),t.addUint8(1),t.addUint16(strLookup(e.min_power__W,{alert_off:65535},i),"min_power__W"),t.addUint16(strLookup(e.max_power__W,{alert_off:65535},i),"max_power__W"),t.addUint16(strLookup(e.min_voltage__V,{alert_off:65535},i),"min_voltage__V"),t.addUint16(strLookup(e.max_voltage__V,{alert_off:65535},i),"max_voltage__V"),t.addUint8(strLookup(e.min_power_factor,{alert_off:255},i),"min_power_factor")}function encode_calendar_config(e,t,i){t.addUint8(32);var a=new BitPack(i);a.addBits(e.sunrise_steps.length,4,"sunrise_step_length"),a.addBits(e.sunset_steps.length,4,"sunset_step_length"),t.addUint8(a.data_byte);var n=new BitPack(i);for(var r of(n.addBit(e.calendar_prefers_meta_pos,"calendar_prefers_meta_pos"),n.addBit(e.calendar_clamps_profiles,"calendar_clamps_profiles"),n.addBit(e.calendar_clamps_dig,"calendar_clamps_dig"),t.addUint8(n.data_byte),t.addInt16(100*e.latitude__deg,"latitude__deg"),t.addInt16(100*e.longitude__deg,"longitude__deg"),e.sunrise_steps))t.addInt8(zen_angle(r.zenith_angle__deg),"zenith_angle__deg"),t.addUint8(strLookup(r.dimming_level__percent,{disabled:255},i),"dimming_level__percent");for(var r of e.sunset_steps)t.addInt8(zen_angle(r.zenith_angle__deg),"zenith_angle__deg"),t.addUint8(strLookup(r.dimming_level__percent,{disabled:255},i),"dimming_level__percent")}function day_shifts(e,t){switch(e){case"holiday":return 0;case"mon":return 1;case"tue":return 2;case"wed":return 3;case"thu":return 4;case"fri":return 5;case"sat":return 6;case"sun":return 7;default:return t.warnings.push("invalid_day "+e),-1}}function convertH2M(e){var t=e.split(":");return 60*parseInt(t[0])+parseInt(t[1])}function encode_profile_config(e,t,i){t.addUint8(33),t.addUint8(e.profile_id,"profile_id"),t.addUint8(e.dimming_steps.length<10?e.dimming_steps.length:"invalid","dimming_steps"),t.addUint8(addressEncode(e.address,i));var a=0;for(var n of e.days_active)a|=1<<day_shifts(n,i);t.addUint8(a),t.addUint8(0);for(var r=0;r<e.dimming_steps.length;r++)t.addUint8(convertH2M(e.dimming_steps[r].step_time)/10,"step_time_"),t.addUint8(strLookup(e.dimming_steps[r].dimming_level__percent,{inactive:255},i),"dimming_level__percent_")}function encode_fade(e,t){return"ignore"===e?255:e<.45||e>90.53?void t.warnings.push("invalid_value"):Math.round(Math.log(e)/Math.log(Math.sqrt(2)))+2}function encode_fade_config(e,t,i){t.addUint8(34),t.addUint8(encode_fade(e.fade_duration__s,i))}function convertMonth(e){var t=e.split("/");return{month:t[0],day:t[1]}}function encode_holiday_config(e,t,i){t.addUint8(35),t.addUint8(e.holidays.length<10?e.holidays.length:"invalid","holiday_length");for(var a=0;a<e.holidays.length;a++){var n=convertMonth(e.holidays[a]);t.addUint8(n.month,"month"),t.addUint8(n.day,"day")}}function encode_dali_monitor_config(e,t,i){t.addUint8(36);var a=new BitPack(i);a.addBit(e.send_dali_alert,"send_dali_alert"),a.addBit(e.correct_dali_dimming_level,"correct_dali_dimming_level"),a.addBit(e.periodic_bus_scan_enabled,"periodic_bus_scan_enabled"),t.addUint8(a.data_byte),t.addUint16(strLookup(e.monitoring_interval__s,{disabled:255},i),"monitoring_interval__s")}function fallback_dim_config(e,t,i){t.addUint8(37),t.addUint8(e.fallback_dimming_level__percent,"fallback_dimming_level__percent")}function utf8ToArr(e){for(var t=[],i=0;i<e.length;i++){var a=e.charCodeAt(i);a<128?t.push(a):a<2048?t.push(a>>6|192,63&a|128):a<65536?t.push(a>>12|224,a>>6&63|128,63&a|128):a<2097152&&t.push(a>>18|240,a>>12&63|128,a>>6&63|128,63&a|128)}return t}function location_config(e,t,i){t.addUint8(38);var a=utf8ToArr(e.address);t.addUint8(a.length,"address_length"),t.addUint32(strLookup(1e7*e.latitude__deg,{not_configured:2147483647},i),"latitude__deg"),t.addUint32(strLookup(1e7*e.longitude__deg,{not_configured:2147483647},i),"longitude__deg");for(var n=0;n<a.length;n++)t.addUint8(a[n])}function lumalink_decode(e,t){switch(e){case"never_advertise":return 0;case"first_commission":return 1;case"every_boot":return 2;case"always":return 3;default:return t.warnings.push("invalid_lumalink_configuration"),-1}}function lumalink_config(e,t,i){t.addUint8(39),t.addUint8(lumalink_decode(e.access_mode,i))}function dig_input_config(e,t,i){t.addUint8(40),t.addUint8(strLookup(e.dig_index,{enable_dig:0,disable_dig:255}),"dig_index");var a=new BitPack(i);a.addBit(e.dig_mode_button,"dig_mode_button"),a.addBit(e.polarity_high_or_rising,"polarity_high_or_rising"),a.addBit(e.alert_on_activation,"alert_on_activation"),a.addBit(e.alert_on_inactivation,"alert_on_inactivation"),t.addUint8(a.data_byte),t.addUint8(addressEncode(e.address,i),"address"),t.addUint8(strLookup(e.active_dimming_level__percent,{inactive:255},i),"active_dimming_level__percent"),t.addUint8(strLookup(e.inactive_dimming_level__percent,{inactive:255},i),"inactive_dimming_level__percent"),t.addUint16(e.on_delay__s,"on_delay__s"),t.addUint16(e.on_delay__s,"on_delay__s")}function light_sensor_config(e,t,i){t.addUint8(41),t.addUint8(strLookup(e.dim_steps.length,{disabled:255},i),"step_count");var a=new BitPack(i);if(a.addBit(e.alert_on_every_step,"alert_on_every_step"),a.addBit(e.light_sensor_clamps_profile,"light_sensor_clamps_profile"),a.addBit(e.light_sensor_clamps_dig,"light_sensor_clamps_dig"),a.addBit(e.interpolate_steps,"interpolate_steps"),t.addUint8(a.data_byte),t.addUint8(e.measurement_duration__s,"measurement_duration__s"),t.addUint8(addressEncode(e.address,i),"address"),"disabled"!=e.dim_steps)for(var n=0;n<e.dim_steps.length;n++)t.addFloat(e.dim_steps[n].light_level__lx,"light_level__lx"),t.addUint8(strLookup(e.dim_steps[n].dimming_level__percent,{inactive:255},i),"dimming_level__percent")}function dim_notify_config(e,t,i){t.addUint8(42),t.addUint8(strLookup(e.random_delay__s/5,{disabled:255},i),"random_delay__s"),t.addUint8(e.packet_limit__s/60,"packet_limit__s")}function multicast_config(e,t,i){t.addUint8(82),t.addUint8(e.multicast_device,"multicast_device"),8!=e.devaddr.length&&i.warnings.push("invalid_devaddr_length"),t.addUint32(parseInt(e.devaddr,16),"devaddr"),32!=e.nwkskey.length&&i.warnings.push("invalid_nwkskey_length"),t.addUint8Arr(e.nwkskey,"nwkskey"),32!=e.appskey.length&&i.warnings.push("invalid_appskey_length"),t.addUint8Arr(e.appskey,"appskey")}function encodeProfile(e,t){switch(e){case"profile_0":return 0;case"profile_1":return 1;case"profile_2":return 2;case"profile_3":return 3;case"profile_4":return 4;case"profile_5":return 5;case"profile_6":return 6;case"profile_7":return 7;case"all_profiles":return 255;default:return t.warnings.push("unkown_profile"),255}}function encodeMulticast(e,t){switch(e){case"multicast_device_0":return 0;case"multicast_device_1":return 1;case"multicast_device_2":return 2;case"multicast_device_3":return 3;case"all_multicast_devices":return 255;default:return t.warnings.push("invalid_multicast_device"),255}}function clear_config(e,t,i){switch(t.addUint8(255),e.reset_target){case"ldr_input_config":t.addUint8(1);break;case"dig_input_config":t.addUint8(3);break;case"profile_config":t.addUint8(33),t.addUint8(encodeProfile(e.address,i),"profile_id");break;case"holiday_config":t.addUint8(35);break;case"multicast_config":t.addUint8(82),t.addUint8(encodeMulticast(e.multicast_device,i),"multicast_device");break;case"factory_reset":t.addUint8(255),t.addUint32(parseInt(e.device_serial,16),"device_serial");break;default:i.warnings.push("invalid_target")}}function encode_conf_requests(e,t,i){switch(e.packet_type){case"ldr_input_config_request":t.addUint8(1);break;case"dig_input_config_request":t.addUint8(3);break;case"status_config_request":t.addUint8(7);break;case"time_config_request":t.addUint8(9);break;case"usage_config_request":t.addUint8(11);break;case"boot_delay_config_request":t.addUint8(13);break;case"onboard_led_config_request":t.addUint8(21);break;case"metering_alert_config_request":t.addUint8(22);break;case"calendar_config_request":t.addUint8(32);break;case"profile_config_request":t.addUint8(33),t.addUint8(encodeProfile(e.profile_id,i),"profile_id");break;case"fade_config_request":t.addUint8(34);break;case"holiday_config_request":t.addUint8(35);break;case"dali_monitor_config_request":t.addUint8(36);break;case"fallback_dim_config_request":t.addUint8(37);break;case"location_config_request":t.addUint8(38);break;case"lumalink_config_request":t.addUint8(39);break;case"dig_input_config_request":t.addUint8(40);break;case"light_sensor_config_request":t.addUint8(41);break;case"dim_notify_config_packet":t.addUint8(42);break;case"multicast_config_request":t.addUint8(82),t.addUint8(e.multicast_device,"multicast_device");break;default:i.warnings.push("invalid_request_packet")}}function pack_address_dim_level(e,t,i){t.addUint8(addressEncode(e.address));var a=strLookup(e.dimming_level__percent,{resume:255},i);t.addUint8(a,"dimming_level__percent")}function manual_dimming(e,t,i){t.addUint8(1);for(var a=0;a<e.destination.length;a++)pack_address_dim_level(e.destination[a],t,i)}function manual_timed_dimming(e,t,i){t.addUint8(9);for(var a=0;a<e.destination.length;a++)pack_address_dim_level(e.destination[a],t,i),t.addUint8(e.destination[a].duration__minutes,"duration__minutes")}function status_usage_request(e,t,i){if(t.addUint8(5),e.dim_map_report_requested)for(var a=0;a<e.drivers.length;a++){t.addUint8(4),t.addUint8(addressEncode(e.drivers[a].address,i),"dali_driver"),t.addUint8(e.drivers[a].dali_min_level,"dali_min_level"),t.addUint8(e.drivers[a].dali_max_level,"dali_max_level");var n=strLookup(e.drivers[a].dimming_curve,{logarithmic:0,linear:1},i);t.addUint8(n,"dimming_curve")}else{var r=new BitPack(i);r.addBit(e.usage_requested,"usage_requested"),r.addBit(e.status_requested,"status_requested"),t.addUint8(r.data_byte)}}function open_drain_ouptut_control(e,t,i){t.addUint8(12);var a=new BitPack(i);a.addBit(e.open_drain_output_on,"open_drain_output_on"),t.addUint8(a.data_byte)}function custom_dali_request(e,t,i){t.addUint8(3),t.addUint8Arr(e.query_data_raw)}function custom_dali_command(e,t,i){t.addUint8(4),t.addUint8Arr(e.dali_command)}function driver_memory_read(e,t,i){t.addUint8(7),t.addUint8(addressEncode(e.address,i),"address"),t.addUint8(e.memory_bank,"memory_bank"),t.addUint8(e.memory_address,"memory_address"),t.addUint8(e.read_size__bytes,"read_size__bytes")}function driver_memory_write(e,t,i){t.addUint8(8),t.addUint8(addressEncode(e.address,i),"address"),t.addUint8(e.memory_bank,"memory_bank"),t.addUint8(e.memory_address,"memory_address")}function address_dali_driver(e,t,i){t.addUint8(10),t.addUint8(addressEncode(e.address,i),"address")}function encode_packet(e,t,i){var a=50;if("deprecated_ldr_input_config_packet"===e.packet_type)encode_deprecated_ldr_input_config(e,t,i);else if("deprecated_dig_input_config_packet"===e.packet_type)encode_deprecated_dig_input_config(e,t,i);else if("status_config_packet"===e.packet_type)status_config(e,t,i);else if("time_config_packet"===e.packet_type)time_config(e,t,i);else if("usage_config_packet"===e.packet_type)usage_config(e,t,i);else if("boot_delay_config_packet"===e.packet_type)boot_delay_config(e,t);else if("onboard_led_config_packet"===e.packet_type)onboard_led_config(e,t,i);else if("metering_alert_config_packet"===e.packet_type)metering_alert_config(e,t,i);else if("calendar_config_packet"===e.packet_type)encode_calendar_config(e,t,i);else if("profile_config_packet"===e.packet_type)encode_profile_config(e,t,i);else if("fade_config_packet"===e.packet_type)encode_fade_config(e,t,i);else if("holiday_config_packet"===e.packet_type)encode_holiday_config(e,t);else if("dali_monitor_config_packet"===e.packet_type)encode_dali_monitor_config(e,t,i);else if("fallback_dim_config_packet"===e.packet_type)fallback_dim_config(e,t);else if("location_config_packet"===e.packet_type)location_config(e,t,i);else if("lumalink_config_packet"===e.packet_type)lumalink_config(e,t,i);else if("dig_input_config_packet"===e.packet_type)dig_input_config(e,t,i);else if("light_sensor_config_packet"===e.packet_type)light_sensor_config(e,t,i);else if("dim_notify_config_packet"===e.packet_type)dim_notify_config(e,t,i);else if("multicast_config_packet"===e.packet_type)multicast_config(e,t,i);else if("clear_config_packet"===e.packet_type)clear_config(e,t,i);else if("chained_config_packet"===e.packet_type){t.addUint8(254);for(var n=0;n<e.payloads.length;n++){var r=encode_packet(e.payloads[n],t,i);0==r&&i.warnings.push("invalid_chained_payload "+e.payloads[n].packet_type),50!=r&&i.warnings.push("non_config_packet_in_chain "+e.payloads[n].packet_type)}}else"activate_dfu_command"===e.packet_type?(t.addUint8(255),a=51):"restart_controller_command"===e.packet_type?(t.addUint8(254),a=51):"manual_dimming"===e.packet_type?(manual_dimming(e,t,i),a=60):"manual_timed_dimming"===e.packet_type?(manual_timed_dimming(e,t,i),a=60):"status_usage_request"===e.packet_type?(status_usage_request(e,t,i),a=60):"open_drain_output_control"===e.packet_type?(open_drain_ouptut_control(e,t,i),a=60):"custom_dali_request"===e.packet_type?(custom_dali_request(e,t),a=60):"custom_dali_command"===e.packet_type?(custom_dali_command(e,t),a=60):"driver_memory_read"===e.packet_type?(driver_memory_read(e,t,i),a=60):"driver_memory_write"===e.packet_type?(driver_memory_write(e,t,i),a=60):"address_dali_driver"===e.packet_type?(address_dali_driver(e,t,i),a=60):"dali_identify"===e.packet_type?(t.addUint8(11),a=60):-1!==e.packet_type.indexOf("_request")?(encode_conf_requests(e,t,i),a=49):(i.warnings.push("invalid_packet_type "+e.packet_type),a=0);return a}function rawEncode(e){var t={errors:[],warnings:[]},i=new BinaryPack(t),a=0,n=e.data;"data"in n&&(n=n.data);try{a=encode_packet(n,i,t)}catch(e){t.errors.push(e.message)}return{bytes:i.buffer,fPort:a,warnings:t.warnings,errors:t.errors}}function stringFromUTF8Array(e){for(var t=[1,1,1,1,2,2,3,0],i=e.length,a="",n=0;n<i;){var r=e[n++];if(128&r){var d=t[r>>3&7];if(!(64&r)||!d||n+d>i)return null;for(r&=63>>d;d>0;d-=1){var _=e[n++];if(128!=(192&_))return null;r=r<<6|63&_}}a+=String.fromCharCode(r)}return a}function BitExtract(e){this.data=e,this.offset=0}function BinaryExtract(e){this.buffer=e,this.offset=0}function pad(e,t){for(var i=""+e;i.length<t;)i="0"+i;return i}function intToHexStr(e,t){return pad(e.toString(16).toUpperCase(),t)}function bytesToHexStr(e){for(var t="",i=0;i<e.length;i+=1)t+=("00"+e[i].toString(16)).slice(-2).toUpperCase();return t}function addressParse(e,t,i){return 1===e?"analog_0_10v":254===e?"dali_broadcast":255===e?t||(i.warnings.push("invalid_address"),"invalid"):1&e?(i.warnings.push("invalid_address"),"invalid"):128&e?"dali_group_"+(e>>1&15).toString():"dali_single_"+(e>>1&63).toString()}function profileParserPartial(e,t,i){var a=e.getUint8();t.profile_id=255===a?"no_profile":a;var n;n=e.getUint8();var r=e.getUint8();t.address=addressParse(r,"all_devices",i);var d=new BitExtract(e.getUint8()),_=[];return d.getBits(1)&&_.push("holiday"),d.getBits(1)&&_.push("mon"),d.getBits(1)&&_.push("tue"),d.getBits(1)&&_.push("wed"),d.getBits(1)&&_.push("thu"),d.getBits(1)&&_.push("fri"),d.getBits(1)&&_.push("sat"),d.getBits(1)&&_.push("sun"),t.days_active=_,e.getUint8(),n}function decodeUnixEpoch(e,t){var i=new Date(1e3*e).toISOString();return e<1420070400&&(i="invalid_timestamp",t.warnings.push("invalid_timestamp")),i}function decodeLdrConfig(e,t){t.packet_type="deprecated_ldr_input_config_packet";var i=e.getUint8();t.ldr_off_threshold_high=255===i?"disabled":i;var a=e.getUint8();t.ldr_on_threshold_low=255===a?"disabled":a;var n=e.getUint8Bits();n.getBits(2),t.trigger_alert_enabled=n.getBits(1)}function decodeLightDimStep(e){var t={},i=e.getFloat(),a=e.getUint8();return t.light_level__lx=formatLightLx(i),t.dimming_level__percent=decodeDimmingLevel(a,"inactive"),t}function decodeLightSensorConfig(e,t,i){if(t.packet_type="light_sensor_config_packet",255!==e.getUint8()){var a=e.getUint8Bits();for(t.alert_on_every_step=a.getBits(1),t.light_sensor_clamps_profile=a.getBits(1),t.light_sensor_clamps_dig=a.getBits(1),t.interpolate_steps=a.getBits(1),t.measurement_duration__s=e.getUint8(),t.address=addressParse(e.getUint8(),"all_devices",i),t.dim_steps=[];e.availableLen();)t.dim_steps.push(decodeLightDimStep(e))}}function decodeDimNotifyConfig(e,t,i){t.packet_type="dim_notify_config_packet";var a=e.getUint8();t.random_delay__s=255===a?"disabled":5*a,t.packet_limit__s=60*e.getUint8()}function decodeDimmingLevel(e,t){return 255===e?t:e}function decodeDigConfig(e,t,i){t.packet_type="deprecated_dig_input_config_packet";var a=e.getUint16();t.light_on_duration__s=65535===a?"dig_input_disabled":a;var n=e.getUint8Bits();n.getBits(1),t.signal_edge_rising=n.getBits(1),t.trigger_alert_enabled=n.getBits(1),t.address=addressParse(e.getUint8(),"all_devices",i),t.dimming_level__percent=decodeDimmingLevel(e.getUint8(),"disabled")}function decodeDigInputConfigNew(e,t,i){if(t.packet_type="dig_input_config_packet",255!==e.getUint8()){var a=e.getUint8Bits();t.dig_mode_button=a.getBits(1),t.polarity_high_or_rising=a.getBits(1),t.alert_on_activation=a.getBits(1),t.alert_on_inactivation=a.getBits(1),t.address=addressParse(e.getUint8(),"all_devices",i),t.active_dimming_level__percent=decodeDimmingLevel(e.getUint8(),"inactive"),t.inactive_dimming_level__percent=decodeDimmingLevel(e.getUint8(),"inactive");var n=e.getUint16(),r=e.getUint16();t.on_delay__s=n,t.off_delay__s=r}}function decodeStepTime(e){var t=10*e,i=Math.trunc(t/60),a=t-60*i;return pad(i,2)+":"+pad(a,2)}function decodeOdRelaySwStep(e){var t={};t.step_time=decodeStepTime(e.getUint8());var i=0!==e.getUint8();return t.open_drain_output_on=i,t}function decodeZenithStep(e){var t={};t.zenith_angle__deg=(e.getInt8()/6+90).toFixed(2);var i=e.getUint8();return t.dimming_level__percent=decodeDimmingLevel(i,"disabled"),t}function decodeCalendarConfigV11(e,t){t.packet_type="calendar_config_packet";var i=e.getUint8Bits(),a=i.getBits(4),n=i.getBits(4),r=e.getUint8Bits();t.calendar_prefers_meta_pos=r.getBits(1),t.calendar_clamps_profiles=r.getBits(1),t.calendar_clamps_dig=r.getBits(1),t.latitude__deg=e.getInt16()/100,t.longitude__deg=e.getInt16()/100,t.sunrise_steps=[],t.sunset_steps=[];for(var d=0;d<a;d+=1)t.sunrise_steps.push(decodeZenithStep(e));for(var _=0;_<n;_+=1)t.sunset_steps.push(decodeZenithStep(e))}function decodeStatusConfig(e,t){t.packet_type="status_config_packet",t.status_interval__s=e.getUint32()}function decodeDimmingStep(e){var t={};return t.step_time=decodeStepTime(e.getUint8()),t.dimming_level__percent=decodeDimmingLevel(e.getUint8(),"inactive"),t}function decodeProfileConfig(e,t,i){t.packet_type="profile_config_packet";var a=profileParserPartial(e,t,i);t.dimming_steps=[];for(var n=0;n<a;n+=1)t.dimming_steps.push(decodeDimmingStep(e))}function decodeTimeConfig(e,t,i){t.packet_type="time_config_packet";var a=e.getUint32();t.device_unix_epoch=0==a?"force_lorawan_devicetimereq":decodeUnixEpoch(a,i)}function decodeUsageConfig(e,t){t.packet_type="usage_config_packet";var i=e.getUint32(),a=e.getUint8();t.usage_interval__s=i,255!==a&&(t.mains_voltage__V=a)}function decodeMonthDay(e){return pad(e.getUint8(),2)+"/"+pad(e.getUint8(),2)}function decodeHolidayConfig(e,t){t.packet_type="holiday_config_packet",t.holidays=[];for(var i=e.getUint8(),a=0;a<i;a+=1)t.holidays.push(decodeMonthDay(e))}function decodeDaliMonitorConfig(e,t){var i=e.getUint8Bits();t.packet_type="dali_monitor_config_packet",t.send_dali_alert=i.getBits(1),t.correct_dali_dimming_level=i.getBits(1),t.periodic_bus_scan_enabled=i.getBits(1);var a=e.getUint16();t.monitoring_interval__s=0===a?"disabled":a}function decodeFallbackDimConfig(e,t){t.packet_type="fallback_dim_config_packet",t.fallback_dimming_level__percent=e.getUint8()}function decodeMulticastFcntConfig(e,t){t.packet_type="multicast_fcnt_config_packet",t.multicast_device=e.getUint8(),t.multicast_fcnt=e.getUint32()}function decodeBootDelayConfig(e,t){t.packet_type="boot_delay_config_packet";var i=1===e.availableLen()?e.getUint8():e.getUint16();t.boot_delay_range__s=i}function decodeFade(e,t){return 255===e?"ignore":e>=16?(t.errors.push("invalid_fade"),"invalid_fade"):[.5,.71,1,1.41,2,2.83,4,5.66,8,11.31,16,22.63,32,45.25,64,90.51][e]}function decodeLocationConfigV11(e,t){t.packet_type="location_config_packet";var i=e.getUint8();t.latitude__deg=e.getInt32()/1e7,t.longitude__deg=e.getInt32()/1e7,t.address=e.getTextUtf8(i)}function decodeLumalinkMode(e,t){switch(e){case 0:return"never_advertise";case 1:return"first_commission";case 2:return"every_boot";case 3:return"always";default:return t.errors.push("invalid_mode"),"invalid_mode"}}function decodeLumalinkConfig(e,t,i){t.packet_type="lumalink_config_packet",t.access_mode=decodeLumalinkMode(e.getUint8(),i)}function decodeLedConfig(e,t){t.packet_type="onboard_led_config_packet";var i=e.getUint8Bits().getBits(1);t.status_led_enabled=i}function alertParamConfig(e,t){return e===t?"alert_off":e}function decodeMeteringAlertConfig(e,t,i){if(t.packet_type="metering_alert_config_packet",1===e.getUint8()){var a=e.getUint16(),n=e.getUint16(),r=e.getUint16(),d=e.getUint16(),_=e.getUint8();t.min_power__W=alertParamConfig(a,65535),t.max_power__W=alertParamConfig(n,65535),t.min_voltage__V=alertParamConfig(r,65535),t.max_voltage__V=alertParamConfig(d,65535),t.min_power_factor=255===_?"alert_off":_/100}else i.errors.push("invalid_packet_type")}function decodeFadeConfig(e,t,i){t.packet_type="fade_config_packet",t.fade_duration__s=decodeFade(e.getUint8(),i)}function decodeMulticastConfig(e,t,i){t.packet_type="multicast_config_packet";var a=e.getUint8();a>3?i.errors.push("invalid_multicast_device"):(t.multicast_device=a,t.devaddr=bytesToHexStr(e.getRaw(4).reverse()),t.nwkskey=bytesToHexStr(e.getRaw(16)),t.appskey=bytesToHexStr(e.getRaw(16)))}function decodeClearConfig(e,t,i){switch(t.packet_type="clear_config_packet",e.getUint8()){case 1:t.reset_target="ldr_input_config";break;case 3:t.reset_target="dig_input_config";break;case 33:t.reset_target="profile_config",t.address=addressParse(e.getUint8(),"all_profiles",i);break;case 35:t.reset_target="holiday_config";break;case 82:t.reset_target="multicast_config";var a=e.getUint8();t.multicast_device=255===a?"all_multicast_devices":"multicast_device_"+a;break;case 255:t.reset_target="factory_reset",t.device_serial=intToHexStr(e.getUint32(),8);break;default:i.errors.push("invalid_clear_config_target")}}function decodeFport50(e,t,i){switch(e.getUint8()){case 1:return void decodeLdrConfig(e,t);case 3:return void decodeDigConfig(e,t,i);case 5:for(t.packet_type="open_drain_output_config_packet",t.switching_steps=[];e.availableLen();)t.switching_steps.push(decodeOdRelaySwStep(e));return;case 7:return void decodeStatusConfig(e,t);case 9:return void decodeTimeConfig(e,t,i);case 11:return void decodeUsageConfig(e,t);case 13:return void decodeBootDelayConfig(e,t);case 21:return void decodeLedConfig(e,t);case 22:return void decodeMeteringAlertConfig(e,t,i);case 82:return void decodeMulticastConfig(e,t,i);case 255:return void decodeClearConfig(e,t,i);case 32:return void decodeCalendarConfigV11(e,t);case 33:return void decodeProfileConfig(e,t,i);case 34:return void decodeFadeConfig(e,t,i);case 35:return void decodeHolidayConfig(e,t);case 36:return void decodeDaliMonitorConfig(e,t);case 37:return void decodeFallbackDimConfig(e,t);case 38:return void decodeLocationConfigV11(e,t);case 39:return void decodeLumalinkConfig(e,t,i);case 40:return void decodeDigInputConfigNew(e,t,i);case 41:return void decodeLightSensorConfig(e,t,i);case 42:return void decodeDimNotifyConfig(e,t);case 83:return void decodeMulticastFcntConfig(e,t);case 254:for(t.packet_type="chained_config_packet",t.payloads=[];e.availableLen();){var a={};decodeFport50(e,a,i),t.payloads.push(a)}return;default:i.errors.push("invalid_packet_type")}}function decodeDimming(e,t){var i={};return i.address=addressParse(e.getUint8(),"all_devices",t),i.dimming_level__percent=decodeDimmingLevel(e.getUint8(),"resume"),i}function decodeDimmingCommand(e,t,i){for(t.packet_type="manual_dimming",t.destination=[];e.availableLen();)t.destination.push(decodeDimming(e,i))}function decodeCustomDaliReq(e,t,i){t.packet_type="custom_dali_request";var a=e.offset;if(t.query_data_raw=bytesToHexStr(e.getRaw(e.availableLen())),e.offset=a,e.availableLen()>3)e.getRaw(e.availableLen());else{var n=e.getUint8();t.address=addressParse(n,null,i),t.dali_query=e.getUint8(),1===e.availableLen()&&(t.dali_response=e.getUint8())}}function decodeCustomDaliCommand(e,t){t.packet_type="custom_dali_command",t.dali_command=bytesToHexStr(e.getRaw(e.availableLen()))}function decodeDimMap(e,t){var i={};return i.address=addressParse(e.getUint8(),null,t),i.dali_min_level=e.getUint8(),i.dali_max_level=e.getUint8(),i.dimming_curve=0===e.getUint8()?"logarithmic":"linear",i}function decodeStatusRequest(e,t,i){t.packet_type="status_usage_request";var a=e.getUint8Bits();if(t.usage_requested=a.getBits(1),t.status_requested=a.getBits(1),t.dim_map_report_requested=a.getBits(1),t.dim_map_report_requested&&e.availableLen()>0)for(t.drivers=[];e.availableLen();)t.drivers.push(decodeDimMap(e,i))}function decodeDriverMemoryPartial(e,t,i){t.address=addressParse(e.getUint8(),null,i),t.memory_bank=e.getUint8(),t.memory_address=e.getUint8()}function decodeDriverMemoryPartialSized(e,t,i){decodeDriverMemoryPartial(e,t,i);var a=e.getUint8();return t.read_size__bytes=a,a}function decodeReadDriverMemory(e,t,i){if(t.packet_type="driver_memory_read",0!==e.availableLen()){var a=decodeDriverMemoryPartialSized(e,t,i);if(e.availableLen()){var n=e.getRaw(a);t.memory_value=bytesToHexStr(n)}}else i.warnings.push("driver_memory_read_failed")}function decodeWriteDriverMemory(e,t,i){t.packet_type="driver_memory_write",0!==e.availableLen()?(decodeDriverMemoryPartial(e,t),t.memory_value=bytesToHexStr(e.getRaw(e.availableLen()))):i.warnings.push("driver_memory_write_failed")}function decodeTimedDimming(e,t){var i={};return i.address=addressParse(e.getUint8(),"all_devices",t),i.dimming_level__percent=decodeDimmingLevel(e.getUint8(),"resume"),i.duration__minutes=e.getUint8(),i}function decodeTimedDimmingCommand(e,t,i){for(t.packet_type="manual_timed_dimming",t.destination=[];e.availableLen();)t.destination.push(decodeTimedDimming(e,i))}function decodeAddressDaliDriver(e,t,i){t.packet_type="address_dali_driver",t.address=addressParse(e.getUint8(),"rescan_dali_bus",i)}function decodeDaliIdentify(e){e.packet_type="dali_identify"}function decodeOpenDrainSwitching(e,t){t.packet_type="open_drain_output_control",t.open_drain_output_on=e.getUint8Bits().getBits(1)}function decodeFport60(e,t,i){switch(e.getUint8()){case 1:return void decodeDimmingCommand(e,t,i);case 3:return void decodeCustomDaliReq(e,t,i);case 4:return void decodeCustomDaliCommand(e,t);case 5:return void decodeStatusRequest(e,t,i);case 7:return void decodeReadDriverMemory(e,t,i);case 8:return void decodeWriteDriverMemory(e,t,i);case 9:return void decodeTimedDimmingCommand(e,t,i);case 12:return void decodeOpenDrainSwitching(e,t);case 10:return void decodeAddressDaliDriver(e,t,i);case 11:return void decodeDaliIdentify(t);default:i.errors.push("invalid_command")}}function formatLightLx(e){var t=Math.log10(e),i=t>=0?t:0,a=i>3?3:i,n=3-Math.trunc(a);return e.toFixed(n)}function decodeFport49(e,t,i){switch(e.getUint8()){case 1:return void(t.packet_type="deprecated_ldr_input_config_request");case 3:return void(t.packet_type="deprecated_dig_input_config_request");case 7:return void(t.packet_type="status_config_request");case 9:return void(t.packet_type="time_config_packet");case 11:return void(t.packet_type="usage_config_request");case 13:return void(t.packet_type="boot_delay_config_request");case 21:return void(t.packet_type="onboard_led_config_request");case 22:return void(t.packet_type="metering_alert_confic_request");case 82:t.packet_type="multicast_config_request";var a=e.getUint8();return void(t.multicast_device=255===a?"all":a);case 32:return void(t.packet_type="calendar_config_request");case 33:t.packet_type="profile_config_request";var n=e.getUint8();return void(t.profile_id=255===n?"all_profiles":n);case 34:return void(t.packet_type="fade_config_request");case 35:return void(t.packet_type="holiday_config_request");case 36:return void(t.packet_type="dali_monitor_config_request");case 37:return void(t.packet_type="fallback_dim_config_request");case 38:return void(t.packet_type="location_config_request");case 39:return void(t.packet_type="lumalink_config_request");case 40:return void(t.packet_type="dig_input_config_request");case 41:return void(t.packet_type="light_input_config_request");default:i.errors.push("invalid_packet_type")}}function decodeFport51(e,t,i){switch(e.getUint8()){case 255:return void(t.packet_type="activate_dfu_command");case 254:return void(t.packet_type="restart_controller_command");default:i.errors.push("invalid_command")}}function decodeByFport(e,t,i,a){var n=new BinaryExtract(t);0===n.availableLen()?a.errors.push("empty_payload"):49===e?decodeFport49(n,i,a):50===e?decodeFport50(n,i,a):51===e?decodeFport51(n,i,a):60===e?decodeFport60(n,i,a):a.errors.push("invalid_fport"),0!==n.availableLen()&&a.errors.push("invalid_payload_length_long")}function decodeRaw(e,t){var i={},a={errors:[],warnings:[]};try{decodeByFport(e,t,i,a)}catch(e){a.errors.push(e.message)}return{data:i,errors:a.errors,warnings:a.warnings}}function decodeDownlink(e){return decodeRaw(e.fPort,e.bytes)}function encodeDownlink(e){return rawEncode(e)}BitPack.prototype.addBit=function(e,t){"string"==typeof e&&(e=e.toLowerCase());var i=parseInt(e);if("true"===e||!0===e||1===i)var a=!0;else if("false"===e||!1===e||0===i)a=!1;else{a=!1;this.err.warnings.push(t+"_invalid_boolean_value")}this.offset+1>=8&&this.err.errors.push(t+"_too_many_bits"),this.data_byte|=a<<this.offset,this.offset+=1},BitPack.prototype.addBits=function(e,t,i){null===(e=parseInt(e))&&this.err.warnings.push(i+"_invalid_bits"),this.offset+t>8&&this.err.errors.push(i+"_too_many_bits");var a=Math.pow(2,t)-1;this.data_byte|=(e&a)<<this.offset,this.offset+=t},BinaryPack.prototype.length=function(){return this.buffer.length},BinaryPack.prototype.int_invalid=function(e,t,i,a,n){return void 0===e?(this.err.warnings.push(n+"_key_not_found"),!0):isNaN(t)?(this.err.warnings.push(n+"_value_not_integer"),!0):t<i?(this.err.warnings.push(n+"_value_too_small"),!0):t>a&&(this.err.warnings.push(n+"_value_too_large"),!0)},BinaryPack.prototype.addFloat=function(e,t){var i=parseFloat(e);if(isNaN(i))return this.err.warnings.push(t+"_value_not_integer"),!0;var a=0;switch(i){case Number.POSITIVE_INFINITY:a=2139095040;break;case Number.NEGATIVE_INFINITY:a=4286578688;break;case 0:a=1073741824;break;case-0:a=3221225472;break;default:if(Number.isNaN(i)){a=2143289344;break}i<=-0&&(a=2147483648,i=-i);var n=Math.floor(Math.log(i)/Math.log(2)),r=i/Math.pow(2,n)*8388608|0;(n+=127)>=255?(n=255,r=0):n<0&&(n=0),a|=n<<23,a|=8388607&r}this.addInt32(a,t)},BinaryPack.prototype.addUint8Arr=function(e){for(var t=0;t<e.length;t+=2)this.buffer.push(parseInt(e.substr(t,2),16))},BinaryPack.prototype.addUint8=function(e,t){var i=parseInt(e);this.int_invalid(e,i,0,255,t)?this.buffer.push(0):this.buffer.push(i)},BinaryPack.prototype.addInt8=function(e,t){var i=parseInt(e);this.int_invalid(e,i,-128,127,t)?this.buffer.push(0):this.buffer.push(i>=0?i:256+i)},BinaryPack.prototype.addUint16=function(e,t){var i=parseInt(e.toString(2).slice(-16),2);if(this.int_invalid(e,i,0,65535,t))return this.buffer.push(0),void this.buffer.push(0);this.buffer.push(255&i),this.buffer.push(i>>8&255)},BinaryPack.prototype.addInt16=function(e,t){var i=parseInt(e);if(this.int_invalid(e,i,-32768,32767,t))return this.buffer.push(0),void this.buffer.push(0);var a=i>=0?i:65536+i;this.buffer.push(255&a),this.buffer.push(a>>8&255)},BinaryPack.prototype.addUint32=function(e,t){var i=parseInt(e);if(this.int_invalid(e,i,0,4294967295,t))return this.buffer.push(0),this.buffer.push(0),this.buffer.push(0),void this.buffer.push(0);this.buffer.push(255&i),this.buffer.push(i>>8&255),this.buffer.push(i>>16&255),this.buffer.push(i>>24&255)},BinaryPack.prototype.addInt32=function(e,t){var i=parseInt(e);if(this.int_invalid(e,i,-2147483648,2147483647,t))return this.buffer.push(0),this.buffer.push(0),this.buffer.push(0),void this.buffer.push(0);var a=i>=0?i:4294967296+i;this.buffer.push(255&a),this.buffer.push(a>>8&255),this.buffer.push(a>>16&255),this.buffer.push(a>>24&255)},BitExtract.prototype._assertOnRemainingLength=function(e){if(0===e)throw Error("invalid zero length bit field");if(this.offset+e>8)throw Error("invalid number of bits extracted")},BitExtract.prototype.getBits=function(e){this._assertOnRemainingLength(e);var t=Math.pow(2,e)-1,i=this.data>>this.offset&t;return this.offset+=e,1===e?Boolean(i):i},BinaryExtract.prototype.availableLen=function(){return this.buffer.length-this.offset},BinaryExtract.prototype._assertOnRemainingLength=function(e){if(e>this.availableLen())throw Error("invalid buffer length: too short")},BinaryExtract.prototype.getUint8=function(){return this._assertOnRemainingLength(1),this.buffer[this.offset++]},BinaryExtract.prototype.getInt8=function(){var e=this.getUint8();return e>127?e-256:e},BinaryExtract.prototype.getUint16=function(){return this._assertOnRemainingLength(2),this.buffer[this.offset++]+256*this.buffer[this.offset++]},BinaryExtract.prototype.getInt16=function(){var e=this.getUint16();return e>32767?e-65536:e},BinaryExtract.prototype.getUint24=function(){return this._assertOnRemainingLength(3),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]},BinaryExtract.prototype.getUint32=function(){return this._assertOnRemainingLength(4),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]+16777216*this.buffer[this.offset++]},BinaryExtract.prototype.getInt32=function(){var e=this.getUint32();return e>2147483647?e-4294967296:e},BinaryExtract.prototype.getUint64=function(){return this.getUint32()+4294967296*this.getUint32()},BinaryExtract.prototype.getTextUtf8=function(e){this._assertOnRemainingLength(e);var t=stringFromUTF8Array(this.buffer.slice(this.offset,this.offset+e));return this.offset+=e,t},BinaryExtract.prototype.getUint8Bits=function(){return new BitExtract(this.getUint8())},BinaryExtract.prototype.getRaw=function(e){this._assertOnRemainingLength(e);var t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},BinaryExtract.prototype.getFloat=function(){var e=this.getUint32(),t=2147483648&e?-1:1,i=(e>>23&255)-127,a=8388607&e;if(128===i)return t*(a?Number.NaN:Number.POSITIVE_INFINITY);if(-127===i){if(0===a)return 0*t;i=-126,a/=1<<22}else a=(a|1<<23)/(1<<23);return t*a*Math.pow(2,i)};
