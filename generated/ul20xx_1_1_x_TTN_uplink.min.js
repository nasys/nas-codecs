function stringFromUTF8Array(e){for(var t=[1,1,1,1,2,2,3,0],i=e.length,n="",r=0;r<i;){var a=e[r++];if(128&a){var o=t[a>>3&7];if(!(64&a)||!o||r+o>i)return null;for(a&=63>>o;o>0;o-=1){var d=e[r++];if(128!=(192&d))return null;a=a<<6|63&d}}n+=String.fromCharCode(a)}return n}function BitExtract(e){this.data=e,this.offset=0}function BinaryExtract(e){this.buffer=e,this.offset=0}function pad(e,t){for(var i=""+e;i.length<t;)i="0"+i;return i}function intToHexStr(e,t){return pad(e.toString(16).toUpperCase(),t)}function bytesToHexStr(e){for(var t="",i=0;i<e.length;i+=1)t+=("00"+e[i].toString(16)).slice(-2).toUpperCase();return t}function addressParse(e,t,i){return 1===e?"analog_0_10v":254===e?"dali_broadcast":255===e?t||(i.warnings.push("invalid_address"),"invalid"):1&e?(i.warnings.push("invalid_address"),"invalid"):128&e?"dali_group_"+(e>>1&15).toString():"dali_single_"+(e>>1&63).toString()}function profileParserPartial(e,t,i){var n=e.getUint8();t.profile_id=255===n?"no_profile":n;var r;r=e.getUint8();var a=e.getUint8();t.address=addressParse(a,"all_devices",i);var o=new BitExtract(e.getUint8()),d=[];return o.getBits(1)&&d.push("holiday"),o.getBits(1)&&d.push("mon"),o.getBits(1)&&d.push("tue"),o.getBits(1)&&d.push("wed"),o.getBits(1)&&d.push("thu"),o.getBits(1)&&d.push("fri"),o.getBits(1)&&d.push("sat"),o.getBits(1)&&d.push("sun"),t.days_active=d,e.getUint8(),r}function decodeUnixEpoch(e,t){var i=new Date(1e3*e).toISOString();return e<1420070400&&(i="invalid_timestamp",t.warnings.push("invalid_timestamp")),i}function decodeLdrConfig(e,t){t.packet_type="deprecated_ldr_input_config_packet";var i=e.getUint8();t.ldr_off_threshold_high=255===i?"disabled":i;var n=e.getUint8();t.ldr_on_threshold_low=255===n?"disabled":n;var r=e.getUint8Bits();r.getBits(2),t.trigger_alert_enabled=r.getBits(1)}function decodeLightDimStep(e){var t={},i=e.getFloat(),n=e.getUint8();return t.light_level__lx=formatLightLx(i),t.dimming_level__percent=decodeDimmingLevel(n,"inactive"),t}function decodeLightSensorConfig(e,t,i){if(t.packet_type="light_sensor_config_packet",255!==e.getUint8()){var n=e.getUint8Bits();for(t.alert_on_every_step=n.getBits(1),t.clamp_profile=n.getBits(1),t.clamp_dig=n.getBits(1),t.interpolate_steps=n.getBits(1),t.measurement_duration__s=e.getUint8(),t.address=addressParse(e.getUint8(),"all_devices",i),t.dim_steps=[];e.availableLen();)t.dim_steps.push(decodeLightDimStep(e))}}function decodeDimNotifyConfig(e,t,i){t.packet_type="dim_notify_config_packet";var n=e.getUint8();t.random_delay__s=255===n?"disabled":5*n,t.packet_limit__s=60*e.getUint8()}function decodeDimmingLevel(e,t){return 255===e?t:e}function decodeDigConfig(e,t,i){t.packet_type="deprecated_dig_input_config_packet";var n=e.getUint16();t.light_on_duration__s=65535===n?"dig_input_disabled":n;var r=e.getUint8Bits();r.getBits(1),t.signal_edge_rising=r.getBits(1),t.trigger_alert_enabled=r.getBits(1),t.address=addressParse(e.getUint8(),"all_devices",i),t.dimming_level__percent=decodeDimmingLevel(e.getUint8(),"disabled")}function decodeDigInputConfigNew(e,t,i){if(t.packet_type="dig_input_config_packet",255!==e.getUint8()){var n=e.getUint8Bits();t.dig_mode_button=n.getBits(1),t.polarity_high_or_rising=n.getBits(1),t.alert_on_activation=n.getBits(1),t.alert_on_inactivation=n.getBits(1),t.address=addressParse(e.getUint8(),"all_devices",i),t.active_dimming_level__percent=decodeDimmingLevel(e.getUint8(),"inactive"),t.inactive_dimming_level__percent=decodeDimmingLevel(e.getUint8(),"inactive");var r=e.getUint16(),a=e.getUint16();t.on_delay__s=r,t.off_delay__s=a}}function decodeStepTime(e){var t=10*e,i=Math.trunc(t/60),n=t-60*i;return pad(i,2)+":"+pad(n,2)}function decodeOdRelaySwStep(e){var t={};t.step_time=decodeStepTime(e.getUint8());var i=0!==e.getUint8();return t.open_drain_output_on=i,t}function decodeZenithStep(e){var t={};t.zenith_angle__deg=(e.getInt8()/6+90).toFixed(2);var i=e.getUint8();return t.dimming_level__percent=decodeDimmingLevel(i,"disabled"),t}function decodeCalendarConfigV11(e,t){t.packet_type="calendar_config_packet";var i=e.getUint8Bits(),n=i.getBits(4),r=i.getBits(4),a=e.getUint8Bits();t.calendar_prefers_meta_pos=a.getBits(1),t.calendar_clamps_profiles=a.getBits(1),t.calendar_clamps_dig=a.getBits(1),t.latitude__deg=e.getInt16()/100,t.longitude__deg=e.getInt16()/100,t.sunrise_steps=[],t.sunset_steps=[];for(var o=0;o<n;o+=1)t.sunrise_steps.push(decodeZenithStep(e));for(var d=0;d<r;d+=1)t.sunset_steps.push(decodeZenithStep(e))}function decodeStatusConfig(e,t){t.packet_type="status_config_packet",t.status_interval__s=e.getUint32()}function decodeDimmingStep(e){var t={};return t.step_time=decodeStepTime(e.getUint8()),t.dimming_level__percent=decodeDimmingLevel(e.getUint8(),"inactive"),t}function decodeProfileConfig(e,t,i){t.packet_type="profile_config_packet";var n=profileParserPartial(e,t,i);t.dimming_steps=[];for(var r=0;r<n;r+=1)t.dimming_steps.push(decodeDimmingStep(e))}function decodeTimeConfig(e,t,i){t.packet_type="time_config_packet";var n=e.getUint32();t.device_unix_epoch=0==n?"force_lorawan_devicetimereq":decodeUnixEpoch(n,i)}function decodeUsageConfig(e,t){t.packet_type="usage_config_packet";var i=e.getUint32(),n=e.getUint8();t.usage_interval__s=i,255!==n&&(t.mains_voltage__V=n)}function decodeMonthDay(e){return pad(e.getUint8(),2)+"/"+pad(e.getUint8(),2)}function decodeHolidayConfig(e,t){t.packet_type="holiday_config_packet",t.holidays=[];for(var i=e.getUint8(),n=0;n<i;n+=1)t.holidays.push(decodeMonthDay(e))}function decodeDaliMonitorConfig(e,t){var i=e.getUint8Bits();t.packet_type="dali_monitor_config_packet",t.send_dali_alert=i.getBits(1),t.correct_dali_dimming_level=i.getBits(1),t.periodic_bus_scan_enabled=i.getBits(1);var n=e.getUint16();t.monitoring_interval__s=0===n?"disabled":n}function decodeFallbackDimConfig(e,t){t.packet_type="fallback_dim_config_packet",t.fallback_dimming_level__percent=e.getUint8()}function decodeMulticastFcntConfig(e,t){t.packet_type="multicast_fcnt_config_packet",t.multicast_device=e.getUint8(),t.multicast_fcnt=e.getUint32()}function decodeBootDelayConfig(e,t){t.packet_type="boot_delay_config_packet";var i=1===e.availableLen()?e.getUint8():e.getUint16();t.boot_delay_range__s=i}function decodeFade(e,t){return 255===e?"ignore":e>=16?(t.errors.push("invalid_fade"),"invalid_fade"):[.5,.71,1,1.41,2,2.83,4,5.66,8,11.31,16,22.63,32,45.25,64,90.51][e]}function decodeLocationConfigV11(e,t){t.packet_type="location_config_packet";var i=e.getUint8();t.latitude__deg=e.getInt32()/1e7,t.longitude__deg=e.getInt32()/1e7,t.address=e.getTextUtf8(i)}function decodeLumalinkMode(e,t){switch(e){case 0:return"never_advertise";case 1:return"first_commission";case 2:return"every_boot";case 3:return"always";default:return t.errors.push("invalid_mode"),"invalid_mode"}}function decodeLumalinkConfig(e,t,i){t.packet_type="lumalink_config_packet",t.access_mode=decodeLumalinkMode(e.getUint8(),i)}function decodeLedConfig(e,t){t.packet_type="onboard_led_config_packet";var i=e.getUint8Bits().getBits(1);t.status_led_enabled=i}function alertParamConfig(e,t){return e===t?"alert_off":e}function decodeMeteringAlertConfig(e,t,i){if(t.packet_type="metering_alert_config_packet",1===e.getUint8()){var n=e.getUint16(),r=e.getUint16(),a=e.getUint16(),o=e.getUint16(),d=e.getUint8();t.min_power__W=alertParamConfig(n,65535),t.max_power__W=alertParamConfig(r,65535),t.min_voltage__V=alertParamConfig(a,65535),t.max_voltage__V=alertParamConfig(o,65535),t.min_power_factor=255===d?"alert_off":d/100}else i.errors.push("invalid_packet_type")}function decodeFadeConfig(e,t,i){t.packet_type="fade_config_packet",t.fade_duration__s=decodeFade(e.getUint8(),i)}function decodeMulticastConfig(e,t,i){t.packet_type="multicast_config_packet";var n=e.getUint8();n>3?i.errors.push("invalid_multicast_device"):(t.multicast_device=n,t.devaddr=bytesToHexStr(e.getRaw(4).reverse()),t.nwkskey=bytesToHexStr(e.getRaw(16)),t.appskey=bytesToHexStr(e.getRaw(16)))}function decodeClearConfig(e,t,i){switch(t.packet_type="clear_config_packet",e.getUint8()){case 1:t.reset_target="ldr_input_config";break;case 3:t.reset_target="dig_input_config";break;case 33:t.reset_target="profile_config",t.address=addressParse(e.getUint8(),"all_profiles",i);break;case 35:t.reset_target="holiday_config";break;case 82:t.reset_target="multicast_config";var n=e.getUint8();t.multicast_device=255===n?"all_multicast_devices":"multicast_device_"+n;break;case 255:t.reset_target="factory_reset",t.device_serial=intToHexStr(e.getUint32(),8);break;default:i.errors.push("invalid_clear_config_target")}}function decodeFport50(e,t,i){switch(e.getUint8()){case 1:return void decodeLdrConfig(e,t);case 3:return void decodeDigConfig(e,t,i);case 5:for(t.packet_type="open_drain_output_config_packet",t.switching_steps=[];e.availableLen();)t.switching_steps.push(decodeOdRelaySwStep(e));return;case 7:return void decodeStatusConfig(e,t);case 9:return void decodeTimeConfig(e,t,i);case 11:return void decodeUsageConfig(e,t);case 13:return void decodeBootDelayConfig(e,t);case 21:return void decodeLedConfig(e,t);case 22:return void decodeMeteringAlertConfig(e,t,i);case 82:return void decodeMulticastConfig(e,t,i);case 255:return void decodeClearConfig(e,t,i);case 32:return void decodeCalendarConfigV11(e,t);case 33:return void decodeProfileConfig(e,t,i);case 34:return void decodeFadeConfig(e,t,i);case 35:return void decodeHolidayConfig(e,t);case 36:return void decodeDaliMonitorConfig(e,t);case 37:return void decodeFallbackDimConfig(e,t);case 38:return void decodeLocationConfigV11(e,t);case 39:return void decodeLumalinkConfig(e,t,i);case 40:return void decodeDigInputConfigNew(e,t,i);case 41:return void decodeLightSensorConfig(e,t,i);case 42:return void decodeDimNotifyConfig(e,t);case 83:return void decodeMulticastFcntConfig(e,t);case 254:for(t.packet_type="chained_config_packet",t.payloads=[];e.availableLen();){var n={};decodeFport50(e,n,i),t.payloads.push(n)}return;default:i.errors.push("invalid_packet_type")}}function decodeDimming(e,t){var i={};return i.address=addressParse(e.getUint8(),"all_devices",t),i.dimming_level__percent=decodeDimmingLevel(e.getUint8(),"resume"),i}function decodeDimmingCommand(e,t,i){for(t.packet_type="manual_dimming",t.destination=[];e.availableLen();)t.destination.push(decodeDimming(e,i))}function decodeCustomDaliReq(e,t,i){t.packet_type="custom_dali_request";var n=e.offset;if(t.query_data_raw=bytesToHexStr(e.getRaw(e.availableLen())),e.offset=n,e.availableLen()>3)e.getRaw(e.availableLen());else{var r=e.getUint8();t.address=addressParse(r,null,i),t.dali_query=e.getUint8(),1===e.availableLen()&&(t.dali_response=e.getUint8())}}function decodeCustomDaliCommand(e,t){t.packet_type="custom_dali_command",t.dali_command=bytesToHexStr(e.getRaw(e.availableLen()))}function decodeDimMap(e,t){var i={};return i.address=addressParse(e.getUint8(),null,t),i.dali_min_level=e.getUint8(),i.dali_max_level=e.getUint8(),i.dimming_curve=0===e.getUint8()?"logarithmic":"linear",i}function decodeStatusRequest(e,t,i){t.packet_type="status_usage_request";var n=e.getUint8Bits();if(t.usage_requested=n.getBits(1),t.status_requested=n.getBits(1),t.dim_map_report_requested=n.getBits(1),t.dim_map_report_requested&&e.availableLen()>0)for(t.drivers=[];e.availableLen();)t.drivers.push(decodeDimMap(e,i))}function decodeDriverMemoryPartial(e,t,i){t.address=addressParse(e.getUint8(),null,i),t.memory_bank=e.getUint8(),t.memory_address=e.getUint8()}function decodeDriverMemoryPartialSized(e,t,i){decodeDriverMemoryPartial(e,t,i);var n=e.getUint8();return t.read_size__bytes=n,n}function decodeReadDriverMemory(e,t,i){if(t.packet_type="driver_memory_read",0!==e.availableLen()){var n=decodeDriverMemoryPartialSized(e,t,i);if(e.availableLen()){var r=e.getRaw(n);t.memory_value=bytesToHexStr(r)}}else i.warnings.push("driver_memory_read_failed")}function decodeWriteDriverMemory(e,t,i){t.packet_type="driver_memory_write",0!==e.availableLen()?(decodeDriverMemoryPartial(e,t),t.memory_value=bytesToHexStr(e.getRaw(e.availableLen()))):i.warnings.push("driver_memory_write_failed")}function decodeTimedDimming(e,t){var i={};return i.address=addressParse(e.getUint8(),"all_devices",t),i.dimming_level__percent=decodeDimmingLevel(e.getUint8(),"resume"),i.duration__minutes=e.getUint8(),i}function decodeTimedDimmingCommand(e,t,i){for(t.packet_type="manual_timed_dimming",t.destination=[];e.availableLen();)t.destination.push(decodeTimedDimming(e,i))}function decodeAddressDaliDriver(e,t,i){t.packet_type="address_dali_driver",t.address=addressParse(e.getUint8(),"rescan_dali_bus",i)}function decodeDaliIdentify(e){e.packet_type="dali_identify"}function decodeOpenDrainSwitching(e,t){t.packet_type="open_drain_output_control",t.open_drain_output_on=e.getUint8Bits().getBits(1)}function decodeFport60(e,t,i){switch(e.getUint8()){case 1:return void decodeDimmingCommand(e,t,i);case 3:return void decodeCustomDaliReq(e,t,i);case 4:return void decodeCustomDaliCommand(e,t);case 5:return void decodeStatusRequest(e,t,i);case 7:return void decodeReadDriverMemory(e,t,i);case 8:return void decodeWriteDriverMemory(e,t,i);case 9:return void decodeTimedDimmingCommand(e,t,i);case 12:return void decodeOpenDrainSwitching(e,t);case 10:return void decodeAddressDaliDriver(e,t,i);case 11:return void decodeDaliIdentify(t);default:i.errors.push("invalid_command")}}function formatLightLx(e){var t=Math.log10(e),i=t>=0?t:0,n=i>3?3:i,r=3-Math.trunc(n);return e.toFixed(r)}function decodeFport49(e,t,i){switch(e.getUint8()){case 1:return void(t.packet_type="deprecated_ldr_input_config_request");case 3:return void(t.packet_type="deprecated_dig_input_config_request");case 7:return void(t.packet_type="status_config_request");case 9:return void(t.packet_type="time_config_packet");case 11:return void(t.packet_type="usage_config_request");case 13:return void(t.packet_type="boot_delay_config_request");case 21:return void(t.packet_type="onboard_led_config_request");case 22:return void(t.packet_type="metering_alert_confic_request");case 82:t.packet_type="multicast_config_request";var n=e.getUint8();return void(t.multicast_device=255===n?"all":n);case 32:return void(t.packet_type="calendar_config_request");case 33:t.packet_type="profile_config_request";var r=e.getUint8();return void(t.profile_id=255===r?"all_profiles":r);case 34:return void(t.packet_type="fade_config_request");case 35:return void(t.packet_type="holiday_config_request");case 36:return void(t.packet_type="dali_monitor_config_request");case 37:return void(t.packet_type="fallback_dim_config_request");case 38:return void(t.packet_type="location_config_request");case 39:return void(t.packet_type="lumalink_config_request");case 40:return void(t.packet_type="dig_input_config_request");case 41:return void(t.packet_type="light_input_config_request");default:i.errors.push("invalid_packet_type")}}function decodeFport51(e,t,i){switch(e.getUint8()){case 255:return void(t.packet_type="activate_dfu_command");case 254:return void(t.packet_type="restart_controller_command");default:i.errors.push("invalid_command")}}function decodeByFport(e,t,i,n){var r=new BinaryExtract(t);0===r.availableLen()?n.errors.push("empty_payload"):49===e?decodeFport49(r,i,n):50===e?decodeFport50(r,i,n):51===e?decodeFport51(r,i,n):60===e?decodeFport60(r,i,n):n.errors.push("invalid_fport"),0!==r.availableLen()&&n.errors.push("invalid_payload_length_long")}function decodeRaw(e,t){var i={},n={errors:[],warnings:[]};try{decodeByFport(e,t,i,n)}catch(e){n.errors.push(e.message)}return{data:i,errors:n.errors,warnings:n.warnings}}function decodeUplink(e){return decodeRaw(e.fPort,e.bytes)}BitExtract.prototype._assertOnRemainingLength=function(e){if(0===e)throw Error("invalid zero length bit field");if(this.offset+e>8)throw Error("invalid number of bits extracted")},BitExtract.prototype.getBits=function(e){this._assertOnRemainingLength(e);var t=Math.pow(2,e)-1,i=this.data>>this.offset&t;return this.offset+=e,1===e?Boolean(i):i},BinaryExtract.prototype.availableLen=function(){return this.buffer.length-this.offset},BinaryExtract.prototype._assertOnRemainingLength=function(e){if(e>this.availableLen())throw Error("invalid buffer length: too short")},BinaryExtract.prototype.getUint8=function(){return this._assertOnRemainingLength(1),this.buffer[this.offset++]},BinaryExtract.prototype.getInt8=function(){var e=this.getUint8();return e>127?e-256:e},BinaryExtract.prototype.getUint16=function(){return this._assertOnRemainingLength(2),this.buffer[this.offset++]+256*this.buffer[this.offset++]},BinaryExtract.prototype.getInt16=function(){var e=this.getUint16();return e>32767?e-65536:e},BinaryExtract.prototype.getUint24=function(){return this._assertOnRemainingLength(3),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]},BinaryExtract.prototype.getUint32=function(){return this._assertOnRemainingLength(4),this.buffer[this.offset++]+256*this.buffer[this.offset++]+65536*this.buffer[this.offset++]+16777216*this.buffer[this.offset++]},BinaryExtract.prototype.getInt32=function(){var e=this.getUint32();return e>2147483647?e-4294967296:e},BinaryExtract.prototype.getUint64=function(){return this.getUint32()+4294967296*this.getUint32()},BinaryExtract.prototype.getTextUtf8=function(e){this._assertOnRemainingLength(e);var t=stringFromUTF8Array(this.buffer.slice(this.offset,this.offset+e));return this.offset+=e,t},BinaryExtract.prototype.getUint8Bits=function(){return new BitExtract(this.getUint8())},BinaryExtract.prototype.getRaw=function(e){this._assertOnRemainingLength(e);var t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t},BinaryExtract.prototype.getFloat=function(){var e=this.getUint32(),t=2147483648&e?-1:1,i=(e>>23&255)-127,n=8388607&e;if(128===i)return t*(n?Number.NaN:Number.POSITIVE_INFINITY);if(-127===i){if(0===n)return 0*t;i=-126,n/=1<<22}else n=(n|1<<23)/(1<<23);return t*n*Math.pow(2,i)};
